<!-- assets/parse-lab.html -->
<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transcript Parser - IRS Transcript Automation</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['DM Sans', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial']
          }
        }
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100%;
      font-family: 'DM Sans', system-ui, sans-serif;
    }

    .container-wrapper {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background: linear-gradient(to bottom, #0f172a, #1e293b);
    }

    .report-page { 
      width: 100%; 
      max-width: 8.5in; 
      margin: 0 auto 24px; 
      background: #ffffff; 
      box-shadow: 0 4px 20px rgba(0,0,0,.10); 
      border-radius: 12px; 
      overflow: hidden; 
    }

    .report-content { 
      padding: 52px; 
      color: #0b0a14; 
      font-family: 'DM Sans', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; 
    }

    .report-header { 
      display:flex; 
      justify-content:space-between; 
      align-items:flex-start; 
      gap:20px; 
      margin-bottom:40px; 
      padding-bottom:18px; 
      border-bottom:2px solid #0b0a14; 
    }

    .report-h1 { 
      font-size: 30px; 
      font-weight: 800; 
      letter-spacing: -0.5px; 
      line-height:1.1; 
    }

    .report-kicker { 
      font-size: 12px; 
      color: #6b7280; 
      text-transform: uppercase; 
      letter-spacing: 1px; 
      font-weight: 700; 
      margin-top: 6px; 
    }

    .report-section { 
      margin-bottom: 34px; 
    }

    .report-title { 
      font-size: 13px; 
      font-weight: 800; 
      color: #0b0a14; 
      text-transform: uppercase; 
      letter-spacing: .5px; 
      margin-bottom: 14px; 
      padding-left: 10px; 
      border-left: 4px solid #7c3aed; 
    }

    .report-grid { 
      display:grid; 
      grid-template-columns: repeat(2, 1fr); 
      gap: 16px; 
    }

    .report-block { 
      background:#f9fafb; 
      padding: 14px; 
      border-radius: 10px; 
      border-left: 3px solid #7c3aed; 
    }

    .report-label { 
      font-size: 11px; 
      font-weight: 700; 
      color:#6b7280; 
      text-transform: uppercase; 
      letter-spacing:.5px; 
      margin-bottom: 6px; 
    }

    .report-value { 
      font-size: 16px; 
      font-weight: 700; 
      color:#0b0a14; 
    }

    .report-status { 
      display:grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 12px; 
    }

    .report-card { 
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); 
      padding: 18px; 
      border-radius: 12px; 
      border: 1px solid #e5e7eb; 
      text-align:center; 
    }

    .report-stat { 
      font-size: 20px; 
      font-weight: 800; 
      margin-bottom: 6px; 
      min-height: 26px; 
    }

    .report-stat.low { 
      color: #059669; 
    }

    .report-stat.moderate { 
      color: #d97706; 
    }

    .report-stat.attention { 
      color: #dc2626; 
    }

    .report-stat-label { 
      font-size: 11px; 
      font-weight: 800; 
      color:#6b7280; 
      text-transform: uppercase; 
      letter-spacing:.5px; 
    }

    .report-summary { 
      background: rgba(124,58,237,.08); 
      border-left: 4px solid #7c3aed; 
      padding: 18px; 
      border-radius: 10px; 
      line-height: 1.7; 
      color:#374151; 
      font-size: 14px; 
    }

    .report-footer { 
      margin-top: 40px; 
      padding-top: 16px; 
      border-top: 1px solid #e5e7eb; 
      display:flex; 
      justify-content:space-between; 
      gap:16px; 
      font-size: 11px; 
      color:#9ca3af; 
    }

    @media (max-width: 640px) {
      .report-content { padding: 28px; }
      .report-grid { grid-template-columns: 1fr; }
      .report-status { grid-template-columns: 1fr; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse-ring {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    input[type="file"] { display: none; }

    .input-field {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: white;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      background: rgba(148, 163, 184, 0.15);
      border-color: rgba(168, 85, 247, 0.5);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .input-field::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    button:disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
    }

    .btn-secondary {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.2);
      border-color: rgba(168, 85, 247, 0.5);
    }

    .glass {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .step-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: rgba(168, 85, 247, 0.2);
      border: 2px solid rgba(168, 85, 247, 0.4);
      border-radius: 50%;
      font-weight: 800;
      font-size: 16px;
      color: #a855f7;
      flex-shrink: 0;
    }

    .success-badge {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .drop-zone {
      border: 2px dashed rgba(168, 85, 247, 0.5);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(168, 85, 247, 0.05);
    }

    .drop-zone:hover {
      border-color: rgba(168, 85, 247, 0.7);
      background: rgba(168, 85, 247, 0.08);
    }

    .drop-zone.active {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.15);
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="container-wrapper">
   <main class="max-w-6xl mx-auto px-6 py-12">
    <!-- Hero Section -->
    <div class="text-center mb-12 fade-in">
     <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Parse Your Transcript in Seconds</h2>
     <p class="text-xl text-slate-300 max-w-2xl mx-auto">Upload an IRS transcript PDF. Get instant code extraction and a client-ready report. No uploads. No risk.</p>
    </div><!-- Parser Card -->
    <div class="glass rounded-2xl p-8 mb-12 fade-in">
     <!-- Steps Indicator -->
     <div class="flex items-center justify-between mb-12 pb-8 border-b border-slate-700/50">
      <div class="flex items-center gap-3">
       <div class="step-number">
        1
       </div>
       <div>
        <div class="text-white font-semibold">
         Enter Token
        </div>
        <div class="text-sm text-slate-400">
         Verify access credits
        </div>
       </div>
      </div>
      <div class="hidden md:flex-1 h-px bg-gradient-to-r from-slate-700/0 via-slate-700/50 to-slate-700/0 mx-4"></div>
      <div class="flex items-center gap-3">
       <div class="step-number">
        2
       </div>
       <div>
        <div class="text-white font-semibold">
         Upload PDF
        </div>
        <div class="text-sm text-slate-400">
         Choose your transcript
        </div>
       </div>
      </div>
      <div class="hidden md:flex-1 h-px bg-gradient-to-r from-slate-700/0 via-slate-700/50 to-slate-700/0 mx-4"></div>
      <div class="flex items-center gap-3">
       <div class="step-number">
        3
       </div>
       <div>
        <div class="text-white font-semibold">
         Preview &amp; Download
        </div>
        <div class="text-sm text-slate-400">
         Get your report
        </div>
       </div>
      </div>
     </div><!-- Step 1: Token Section -->
     <div class="mb-10 pb-10 border-b border-slate-700/30">
      <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-3"><span class="step-number text-sm">1</span> Enter Your API Token</h3>
      <div class="space-y-4">
       <div>
        <label for="parser-token-id" class="block text-sm font-medium text-slate-300 mb-2">API Token ID</label> <input id="parser-token-id" type="text" placeholder="Paste your token ID here" class="input-field w-full rounded-lg px-4 py-3" autocomplete="off">
        <p class="text-xs text-slate-400 mt-2">Your token is never stored or transmitted. It only validates locally.</p>
       </div>
       <div class="flex items-center justify-between gap-4">
        <div class="text-sm text-slate-300">
         <span class="text-slate-400">Available credits:</span> <span id="parser-token-available" class="ml-2 font-semibold text-purple-400">-</span>
        </div><button id="parser-save-token" type="button" class="btn-secondary text-sm px-4 py-2"> Verify Token </button>
       </div>
       <div id="parser-token-status" class="text-xs text-slate-400 p-3 rounded-lg bg-slate-800/30 border border-slate-700/30">
        Enter a valid token to activate parsing.
       </div>
      </div>
     </div><!-- Step 2: Upload Section -->
     <div class="mb-10 pb-10 border-b border-slate-700/30">
      <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-3"><span class="step-number text-sm">2</span> Upload Your Transcript</h3><!-- Firm Logo Optional -->
      <div class="mb-8">
       <label class="block text-sm font-medium text-slate-300 mb-3">Firm Logo (Optional)</label> <label for="brand-logo" class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 btn-secondary rounded-lg">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg><span>Choose Logo File</span> </label> <input id="brand-logo" type="file" accept="image/*"> <span id="brand-logo-file-name" class="text-sm text-slate-400 ml-3">No file selected</span>
       <p class="text-xs text-slate-500 mt-3">Recommended: 600×600 PNG, SVG, or JPG</p>
      </div><!-- PDF Drop Zone -->
      <div class="drop-zone fade-in" id="pdf-drop-zone">
       <svg class="w-16 h-16 text-purple-400 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
       </svg>
       <p class="text-white font-semibold mb-2">Drop IRS transcript PDF here</p>
       <p class="text-slate-400 text-sm">or click to browse</p>
       <p class="text-slate-500 text-xs mt-3">Supports Form 4506-C (Account, Return, Wage &amp; Income transcripts)</p>
      </div><input id="pdf-upload" type="file" accept="application/pdf" class="hidden">
     </div><!-- Step 3: Parse Controls -->
     <div class="grid gap-4">
      <div class="flex flex-col md:flex-row gap-4">
       <button id="extract-raw-btn" type="button" class="btn-secondary flex-1 opacity-50 cursor-not-allowed" disabled>
        <span>Extract Raw Text</span>
       </button>
       <button id="parse-structured-btn" type="button" class="btn-primary flex-1 opacity-50 cursor-not-allowed" disabled>
        <span>Parse Structured JSON</span>
       </button>
       <a id="preview-report-btn" href="#" class="btn-secondary flex-1 text-center opacity-50 cursor-not-allowed pointer-events-none" aria-disabled="true"> Preview Report </a>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
       <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/40">
         <div class="text-sm font-semibold text-white">Raw Text Output</div>
         <button id="copy-raw" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200">Copy</button>
        </div>
        <pre id="raw-output" class="p-4 text-xs text-slate-200 whitespace-pre-wrap break-words max-h-[320px] overflow-auto">(no text yet)</pre>
       </div>
       <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/40">
         <div class="text-sm font-semibold text-white">Structured JSON Output</div>
         <button id="copy-json" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200">Copy</button>
        </div>
        <pre id="json-output" class="p-4 text-xs text-slate-200 whitespace-pre-wrap break-words max-h-[320px] overflow-auto">(no json yet)</pre>
       </div>
      </div>
     </div><!-- Security Notice -->
     <div class="mt-8 p-4 rounded-lg bg-slate-800/30 border border-slate-700/30 flex items-start gap-3">
      <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="currentColor" viewbox="0 0 20 20">
       <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </svg>
      <div>
       <p class="text-sm text-green-300 font-medium">Privacy Protected</p>
       <p class="text-xs text-slate-400 mt-1">PDFs are processed in your browser. No files are uploaded or stored on our servers.</p>
      </div>
     </div>
    </div><!-- Info Cards -->
    <div class="grid md:grid-cols-3 gap-6 mb-12">
     <div class="glass rounded-xl p-6 border border-purple-500/20">
      <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-300 mb-3" aria-hidden="true">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
       </svg>
      </div>
      <h4 class="text-white font-semibold mb-2">Lightning Fast</h4>
      <p class="text-sm text-slate-400">Parse transcripts in seconds. Handle multiple clients back-to-back.</p>
     </div>
     <div class="glass rounded-xl p-6 border border-purple-500/20">
      <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-300 mb-3" aria-hidden="true">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3V7a3 3 0 10-6 0v1c0 1.657 1.343 3 3 3z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 11h12a2 2 0 012 2v7a2 2 0 01-2 2H6a2 2 0 01-2-2v-7a2 2 0 012-2z" />
       </svg>
      </div>
      <h4 class="text-white font-semibold mb-2">Completely Private</h4>
      <p class="text-sm text-slate-400">All processing happens locally in your browser. Zero server uploads.</p>
     </div>
     <div class="glass rounded-xl p-6 border border-purple-500/20">
      <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-300 mb-3" aria-hidden="true">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 19V5" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 19h16" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17V11" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17V7" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 17v-4" />
       </svg>
      </div>
      <h4 class="text-white font-semibold mb-2">Professional Reports</h4>
      <p class="text-sm text-slate-400">Client-ready summaries with your branding, ready to download.</p>
     </div>
    </div><!-- Sample Report Container -->
    <div id="sample-report-container" class="hidden"></div>
   </main><!-- Modal for Full Report Preview -->
   <div id="mini-report-overlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
    <div class="relative w-full max-w-5xl h-[85vh] bg-slate-950 rounded-2xl overflow-hidden border border-purple-500/20">
     <button id="mini-report-close" class="absolute top-4 right-4 z-10 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"> Close </button> <iframe id="mini-report-iframe" src="" class="w-full h-full border-0"></iframe>
    </div>
   </div>
  </div>
  <script>
    // Parse Lab v2: in-browser PDF extraction + first-pass transcript parsing

    // DOM (alphabetical)
    const brandLogoInput = document.getElementById('brand-logo');
    const brandLogoName = document.getElementById('brand-logo-file-name');
    const copyJsonBtn = document.getElementById('copy-json');
    const copyRawBtn = document.getElementById('copy-raw');
    const extractRawBtn = document.getElementById('extract-raw-btn');
    const jsonOutput = document.getElementById('json-output');
    const miniReportClose = document.getElementById('mini-report-close');
    const miniReportIframe = document.getElementById('mini-report-iframe');
    const miniReportOverlay = document.getElementById('mini-report-overlay');
    const parseStructuredBtn = document.getElementById('parse-structured-btn');
    const parserTokenBtn = document.getElementById('parser-save-token');
    const parserTokenInput = document.getElementById('parser-token-id');
    const parserTokenStatus = document.getElementById('parser-token-status');
    const pdfDropZone = document.getElementById('pdf-drop-zone');
    const pdfUpload = document.getElementById('pdf-upload');
    const previewReportBtn = document.getElementById('preview-report-btn');
    const rawOutput = document.getElementById('raw-output');

    const NL = String.fromCharCode(10);

    const state = {
      brandLogoDataUrl: '',
      pdfFile: null,
      rawText: '',
      structured: null,
      tokenValid: false,
    };

    function setParserAvailable(val) {
      const el = document.getElementById('parser-token-available');
      if (!el) return;
      el.textContent = (val === null || typeof val === 'undefined') ? '-' : String(val);
    }

    function setText(el, text) {
      if (!el) return;
      el.textContent = String(text ?? '');
    }

    function setTokenStatus(msg, tone) {
      const base = 'text-xs p-3 rounded-lg bg-slate-800/30 border border-slate-700/30 ';
      const color = tone === 'error' ? 'text-red-300' : (tone === 'ok' ? 'text-green-300' : 'text-slate-400');
      parserTokenStatus.className = base + color;
      setText(parserTokenStatus, msg);
    }

    function setButtonEnabled(btn, enabled) {
      if (!btn) return;
      btn.disabled = !enabled;
      btn.classList.toggle('opacity-50', !enabled);
      btn.classList.toggle('cursor-not-allowed', !enabled);
    }

    function setPreviewEnabled(enabled) {
      if (enabled) {
        previewReportBtn.classList.remove('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
        previewReportBtn.setAttribute('aria-disabled', 'false');
      } else {
        previewReportBtn.classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
        previewReportBtn.setAttribute('aria-disabled', 'true');
      }
    }

    function updateControls() {
      const hasPdf = !!state.pdfFile;
      const canExtract = state.tokenValid && hasPdf;
      const canParse = state.tokenValid && hasPdf && !!state.rawText;

      setButtonEnabled(extractRawBtn, canExtract);
      setButtonEnabled(parseStructuredBtn, canParse);
      setPreviewEnabled(!!state.structured);
    }

    async function copyToClipboard(text) {
      const value = String(text ?? '');
      if (!value) return;
      try {
        await navigator.clipboard.writeText(value);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
    }

    function ensurePdfJs() {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js failed to load (pdfjsLib is undefined).');
      }
      if (!pdfjsLib.GlobalWorkerOptions || !pdfjsLib.GlobalWorkerOptions.workerSrc) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js';
      }
    }

    async function extractTextFromPDF(file) {
      ensurePdfJs();
      if (!file) throw new Error('No PDF selected.');

      const buf = await file.arrayBuffer();
      const attempts = [
        { data: buf },
        { data: buf, disableWorker: true },
      ];

      let lastErr = null;

      for (const opts of attempts) {
        try {
          const loadingTask = pdfjsLib.getDocument(opts);
          const pdf = await loadingTask.promise;

          let out = '';
          for (let p = 1; p <= pdf.numPages; p++) {
            const page = await pdf.getPage(p);
            const content = await page.getTextContent();
            const parts = [];
            for (const it of content.items) {
              if (it && it.str) parts.push(String(it.str));
            }
            out += parts.join(' ') + NL;
          }

          return out.trim();
        } catch (e) {
          lastErr = e;
        }
      }

      throw lastErr || new Error('PDF extraction failed.');
    }

    function detectTranscriptType(rawText) {
      const t = String(rawText || '').toLowerCase();
      if (t.includes('record of account')) return 'record_of_account';
      if (t.includes('account transcript')) return 'account';
      if (t.includes('return transcript')) return 'return';
      if (t.includes('wage') && t.includes('income')) return 'wage_income';
      return 'unknown';
    }

    function stripLeadingPunct(s) {
      let out = String(s || '').trim();
      while (out.length && (out[0] === ':' || out[0] === ' ')) out = out.slice(1);
      return out.trim();
    }

    function findAfterLabel(rawText, label) {
      const lines = String(rawText || '').split(NL);
      const needle = String(label || '').toLowerCase();
      for (const line of lines) {
        const l = String(line).toLowerCase();
        const idx = l.indexOf(needle);
        if (idx === -1) continue;
        const after = String(line).slice(idx + needle.length).trim();
        if (!after) continue;
        return stripLeadingPunct(after);
      }
      return '';
    }

    function isDigit(ch) {
      return ch >= '0' && ch <= '9';
    }

    function looksLikeDate10(s) {
      if (!s || s.length !== 10) return false;
      // MM/DD/YYYY
      return isDigit(s[0]) && isDigit(s[1]) && s[2] === '/' && isDigit(s[3]) && isDigit(s[4]) && s[5] === '/' &&
        isDigit(s[6]) && isDigit(s[7]) && isDigit(s[8]) && isDigit(s[9]);
    }

    function parseTransactions(rawText) {
      const lines = String(rawText || '').split(NL).map((l) => String(l).trim()).filter(Boolean);
      const out = [];

      for (const line of lines) {
        let code = '';

        const upper = line.toUpperCase();
        const tcIdx = upper.indexOf('TC ');
        if (tcIdx !== -1) {
          const chunk = line.slice(tcIdx + 3).trim();
          code = chunk.slice(0, 3);
        } else {
          for (let i = 0; i < line.length - 2; i++) {
            const a = line[i], b = line[i + 1], c = line[i + 2];
            if (isDigit(a) && isDigit(b) && isDigit(c)) { code = a + b + c; break; }
          }
        }

        if (!code || code.length !== 3) continue;
        if (!isDigit(code[0]) || !isDigit(code[1]) || !isDigit(code[2])) continue;

        let date = '';
        for (let i = 0; i < line.length - 9; i++) {
          const s = line.slice(i, i + 10);
          if (looksLikeDate10(s)) { date = s; break; }
        }

        let amount = '';
        const tokens = line.split(' ').filter(Boolean);
        for (let i = tokens.length - 1; i >= 0; i--) {
          const tok = tokens[i];
          let hasNumber = false;
          for (let j = 0; j < tok.length; j++) {
            if (isDigit(tok[j])) { hasNumber = true; break; }
          }
          if (hasNumber) { amount = tok; break; }
        }

        out.push({ amount, code, date, line });
      }

      const seen = new Set();
      return out.filter((t) => {
        if (seen.has(t.line)) return false;
        seen.add(t.line);
        return true;
      });
    }

    function buildStructured(rawText) {
      const transcriptType = detectTranscriptType(rawText);
      const taxPeriod = findAfterLabel(rawText, 'Tax Period');
      const tinMasked = findAfterLabel(rawText, 'SSN');
      const transactions = parseTransactions(rawText);

      const codesSet = new Set();
      for (const t of transactions) codesSet.add(t.code);
      const codesFound = Array.from(codesSet).sort();

      return {
        codesFound,
        meta: { taxPeriod, tinMasked, transcriptType },
        transactions,
        version: 'parse_lab_v2_first_pass',
      };
    }

    function handlePdfSelected(file) {
      state.pdfFile = file;
      state.rawText = '';
      state.structured = null;

      setText(rawOutput, '(ready. click Extract Raw Text)');
      setText(jsonOutput, '(no json yet)');

      const p = pdfDropZone.querySelector('p.text-white');
      if (p) {
        const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
        p.textContent = 'Selected: ' + file.name + ' • ' + sizeMb + ' MB';
      }

      updateControls();
    }

    function closeOverlay() {
      miniReportOverlay.classList.add('hidden');
      miniReportIframe.srcdoc = '';
      document.body.style.overflow = '';
    }

    // Events
    brandLogoInput.addEventListener('change', (e) => {
      const f = e.target && e.target.files && e.target.files[0];
      brandLogoName.textContent = f ? f.name : 'No file selected';
      state.brandLogoDataUrl = '';
      if (!f) return;

      const reader = new FileReader();
      reader.onload = () => { state.brandLogoDataUrl = String(reader.result || ''); };
      reader.readAsDataURL(f);
    });

    copyJsonBtn.addEventListener('click', () => copyToClipboard(jsonOutput.textContent || ''));
    copyRawBtn.addEventListener('click', () => copyToClipboard(rawOutput.textContent || ''));

    parserTokenBtn.addEventListener('click', () => {
      const token = String(parserTokenInput.value || '').trim();
      if (!token) {
        state.tokenValid = false;
        setParserAvailable('-');
        setTokenStatus('Please enter a token ID.', 'error');
        updateControls();
        return;
      }

      state.tokenValid = token.length >= 8;
      if (!state.tokenValid) {
        setParserAvailable('-');
        setTokenStatus('Token looks invalid (must be at least 8 characters).', 'error');
        updateControls();
        return;
      }

      setParserAvailable(150);
      setTokenStatus('✓ Token verified (local check). Upload a PDF to extract text.', 'ok');
      updateControls();
    });

    pdfDropZone.addEventListener('click', () => pdfUpload.click());

    pdfDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      pdfDropZone.classList.add('active');
    });

    pdfDropZone.addEventListener('dragleave', () => {
      pdfDropZone.classList.remove('active');
    });

    pdfDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      pdfDropZone.classList.remove('active');

      const files = e.dataTransfer && e.dataTransfer.files;
      if (!files || !files.length) return;

      const f = files[0];
      if (f.type !== 'application/pdf') {
        setTokenStatus('That file is not a PDF.', 'error');
        return;
      }

      pdfUpload.files = files;
      handlePdfSelected(f);
    });

    pdfUpload.addEventListener('change', (e) => {
      const f = e.target && e.target.files && e.target.files[0];
      if (!f) return;
      handlePdfSelected(f);
    });

    extractRawBtn.addEventListener('click', async () => {
      if (!state.tokenValid || !state.pdfFile) return;

      setButtonEnabled(extractRawBtn, false);
      setText(rawOutput, 'Extracting text…');

      try {
        const text = await extractTextFromPDF(state.pdfFile);
        state.rawText = text;
        setText(rawOutput, text || '(no text extracted)');
        setTokenStatus('Raw text extracted. Now parse structured JSON.', 'ok');
      } catch (e) {
        state.rawText = '';
        setText(rawOutput, '(extraction failed)');
        setTokenStatus(String(e && e.message ? e.message : e), 'error');
      } finally {
        updateControls();
      }
    });

    parseStructuredBtn.addEventListener('click', () => {
      if (!state.tokenValid || !state.pdfFile || !state.rawText) return;

      setButtonEnabled(parseStructuredBtn, false);
      setText(jsonOutput, 'Parsing…');

      try {
        const structured = buildStructured(state.rawText);
        state.structured = structured;
        setText(jsonOutput, JSON.stringify(structured, null, 2));
        setTokenStatus('Parsed ' + structured.codesFound.length + ' unique codes.', 'ok');
      } catch (e) {
        state.structured = null;
        setText(jsonOutput, '(parse failed)');
        setTokenStatus(String(e && e.message ? e.message : e), 'error');
      } finally {
        updateControls();
      }
    });

    previewReportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (!state.structured) return;

      miniReportOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      const meta = state.structured.meta || {};
      const codes = (state.structured.codesFound || []).slice(0, 24);

      const logoHtml = state.brandLogoDataUrl
        ? '<img src="' + state.brandLogoDataUrl + '" alt="Firm logo" style="max-width:140px;height:auto;" />'
        : '<div style="font-weight:800;letter-spacing:-.5px;">Your Firm</div>';

      const codesHtml = codes.map((c) => '<span class="code">' + String(c) + '</span>').join('');

      miniReportIframe.srcdoc =
        '<!doctype html><html><head><meta charset="utf-8" />' +
        '<meta name="viewport" content="width=device-width, initial-scale=1" />' +
        '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">' +
        '<style>' +
        'body{margin:0;background:#f3f4f6;font-family:DM Sans,system-ui,sans-serif}' +
        '.page{max-width:8.5in;margin:24px auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.10)}' +
        '.content{padding:52px;color:#0b0a14}' +
        '.header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:40px;padding-bottom:18px;border-bottom:2px solid #0b0a14}' +
        '.h1{font-size:30px;font-weight:800;letter-spacing:-.5px;line-height:1.1;margin:0}' +
        '.kicker{font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-top:6px}' +
        '.title{font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px;padding-left:10px;border-left:4px solid #7c3aed}' +
        '.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}' +
        '.block{background:#f9fafb;padding:14px;border-radius:10px;border-left:3px solid #7c3aed}' +
        '.label{font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}' +
        '.value{font-size:16px;font-weight:700}' +
        '.codes{display:flex;flex-wrap:wrap;gap:8px}' +
        '.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:12px;background:#111827;color:#a78bfa;padding:6px 8px;border-radius:8px}' +
        '.footer{margin-top:40px;padding-top:16px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;gap:16px;font-size:11px;color:#9ca3af}' +
        '@media(max-width:640px){.content{padding:28px}.grid{grid-template-columns:1fr}}' +
        '</style></head><body>' +
        '<div class="page"><div class="content">' +
        '<div class="header"><div>' +
        '<h1 class="h1">Transcript Summary</h1>' +
        '<div class="kicker">Transcript type: ' + String(meta.transcriptType || 'unknown') + '</div>' +
        '</div><div>' + logoHtml + '</div></div>' +
        '<div style="margin-bottom:34px;">' +
        '<div class="title">Key information</div>' +
        '<div class="grid">' +
        '<div class="block"><div class="label">Tax period</div><div class="value">' + String(meta.taxPeriod || '-') + '</div></div>' +
        '<div class="block"><div class="label">TIN</div><div class="value">' + String(meta.tinMasked || '-') + '</div></div>' +
        '<div class="block"><div class="label">Codes found</div><div class="value">' + String((state.structured.codesFound || []).length) + '</div></div>' +
        '<div class="block"><div class="label">Rows detected</div><div class="value">' + String((state.structured.transactions || []).length) + '</div></div>' +
        '</div></div>' +
        '<div style="margin-bottom:34px;">' +
        '<div class="title">Sample codes</div>' +
        '<div class="codes">' + codesHtml + '</div>' +
        '</div>' +
        '<div class="footer"><div>Generated locally in-browser</div><div>Transcript.Tax Monitor Pro</div></div>' +
        '</div></div></body></html>';
    });

    miniReportClose.addEventListener('click', () => closeOverlay());
    miniReportOverlay.addEventListener('click', (e) => { if (e.target === miniReportOverlay) closeOverlay(); });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !miniReportOverlay.classList.contains('hidden')) closeOverlay();
    });

    // Init
    updateControls();
  </script>
 </body>
</html>
