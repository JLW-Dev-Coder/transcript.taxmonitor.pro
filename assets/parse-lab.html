<!-- assets/parse-lab.html -->
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transcript Parser - IRS Transcript Automation</title>

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['DM Sans', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial']
          }
        }
      }
    };
  </script>

  <!-- PDF.js: loaded dynamically (local-first). External CDNs may be blocked. -->

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100%;
      font-family: 'DM Sans', system-ui, sans-serif;
    }

    .container-wrapper {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background: linear-gradient(to bottom, #0f172a, #1e293b);
    }

    .report-page {
      width: 100%;
      max-width: 8.5in;
      margin: 0 auto 24px;
      background: #ffffff;
      box-shadow: 0 4px 20px rgba(0,0,0,.10);
      border-radius: 12px;
      overflow: hidden;
    }

    .report-content {
      padding: 52px;
      color: #0b0a14;
      font-family: 'DM Sans', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 40px;
      padding-bottom: 18px;
      border-bottom: 2px solid #0b0a14;
    }

    .report-h1 {
      font-size: 30px;
      font-weight: 800;
      letter-spacing: -0.5px;
      line-height: 1.1;
    }

    .report-kicker {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      margin-top: 6px;
    }

    .report-section { margin-bottom: 34px; }

    .report-title {
      font-size: 13px;
      font-weight: 800;
      color: #0b0a14;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 14px;
      padding-left: 10px;
      border-left: 4px solid #7c3aed;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .report-block {
      background: #f9fafb;
      padding: 14px;
      border-radius: 10px;
      border-left: 3px solid #7c3aed;
    }

    .report-label {
      font-size: 11px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 6px;
    }

    .report-value {
      font-size: 16px;
      font-weight: 700;
      color: #0b0a14;
    }

    .report-status {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .report-card {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      padding: 18px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }

    .report-stat {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 6px;
      min-height: 26px;
    }

    .report-stat.low { color: #059669; }
    .report-stat.moderate { color: #d97706; }
    .report-stat.attention { color: #dc2626; }

    .report-stat-label {
      font-size: 11px;
      font-weight: 800;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    .report-summary {
      background: rgba(124,58,237,.08);
      border-left: 4px solid #7c3aed;
      padding: 18px;
      border-radius: 10px;
      line-height: 1.7;
      color: #374151;
      font-size: 14px;
    }

    .report-footer {
      margin-top: 40px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: 16px;
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .report-content { padding: 28px; }
      .report-grid { grid-template-columns: 1fr; }
      .report-status { grid-template-columns: 1fr; }
    }

    .fade-in { animation: fadeIn 0.5s ease-in; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse-ring { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    input[type="file"] { display: none; }

    .input-field {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: white;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      background: rgba(148, 163, 184, 0.15);
      border-color: rgba(168, 85, 247, 0.5);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .input-field::placeholder { color: rgba(255, 255, 255, 0.5); }

    button:disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
    }

    .btn-secondary {
      background: rgba(168, 85, 247, 0.1);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.2);
      border-color: rgba(168, 85, 247, 0.5);
    }

    .glass {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .step-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: rgba(168, 85, 247, 0.2);
      border: 2px solid rgba(168, 85, 247, 0.4);
      border-radius: 50%;
      font-weight: 800;
      font-size: 16px;
      color: #a855f7;
      flex-shrink: 0;
    }

    .success-badge {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .drop-zone {
      border: 2px dashed rgba(168, 85, 247, 0.5);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(168, 85, 247, 0.05);
    }

    .drop-zone:hover {
      border-color: rgba(168, 85, 247, 0.7);
      background: rgba(168, 85, 247, 0.08);
    }

    .drop-zone.active {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.15);
    }
  </style>

  <!-- IMPORTANT: Do not include /_sdk/data_sdk.js unless that file exists.
       When it 404s, Pages often returns HTML, which the browser tries to parse as JS and throws:
       SyntaxError: Invalid or unexpected token / Unexpected token '<' -->
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
</head>

<body>
  <div class="container-wrapper">
    <main class="max-w-6xl mx-auto px-6 py-12">
      <div class="text-center mb-12 fade-in">
        <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Parse Your Transcript in Seconds</h2>
        <p class="text-xl text-slate-300 max-w-2xl mx-auto">Upload an IRS transcript PDF. Get instant code extraction and a client-ready report. No uploads. No risk.</p>
      </div>

      <div class="glass rounded-2xl p-8 mb-12 fade-in">
        <div class="flex items-center justify-between mb-12 pb-8 border-b border-slate-700/50">
          <div class="flex items-center gap-3">
            <div class="step-number">1</div>
            <div>
              <div class="text-white font-semibold">Enter Token</div>
              <div class="text-sm text-slate-400">Verify access credits</div>
            </div>
          </div>

          <div class="hidden md:flex-1 h-px bg-gradient-to-r from-slate-700/0 via-slate-700/50 to-slate-700/0 mx-4"></div>

          <div class="flex items-center gap-3">
            <div class="step-number">2</div>
            <div>
              <div class="text-white font-semibold">Upload PDF</div>
              <div class="text-sm text-slate-400">Choose your transcript</div>
            </div>
          </div>

          <div class="hidden md:flex-1 h-px bg-gradient-to-r from-slate-700/0 via-slate-700/50 to-slate-700/0 mx-4"></div>

          <div class="flex items-center gap-3">
            <div class="step-number">3</div>
            <div>
              <div class="text-white font-semibold">Preview &amp; Download</div>
              <div class="text-sm text-slate-400">Get your report</div>
            </div>
          </div>
        </div>

        <div class="mb-10 pb-10 border-b border-slate-700/30">
          <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-3">
            <span class="step-number text-sm">1</span> Enter Your Token
          </h3>

          <div class="space-y-4">
            <div>
              <label for="parser-token-id" class="block text-sm font-medium text-slate-300 mb-2">Token ID</label>
              <input id="parser-token-id" type="text" placeholder="Paste your token ID here" class="input-field w-full rounded-lg px-4 py-3" autocomplete="off" />
              <p class="text-xs text-slate-400 mt-2">We use your token to check your remaining credits and (when you choose) consume a credit. We do not store your token.</p>
            </div>

            <div class="flex items-center justify-between gap-4">
              <div class="text-sm text-slate-300">
                <span class="text-slate-400">Available credits:</span>
                <span id="parser-token-available" class="ml-2 font-semibold text-purple-400">-</span>
              </div>
              <button id="parser-save-token" type="button" class="btn-secondary text-sm px-4 py-2">Verify Token</button>
            </div>

            <div id="parser-token-status" class="text-xs text-slate-400 p-3 rounded-lg bg-slate-800/30 border border-slate-700/30">Enter a valid token to activate parsing.</div>
          </div>
        </div>

        <div class="mb-10 pb-10 border-b border-slate-700/30">
          <h3 class="text-lg font-semibold text-white mb-6 flex items-center gap-3">
            <span class="step-number text-sm">2</span> Upload Your Transcript
          </h3>

          <div class="mb-8">
            <label class="block text-sm font-medium text-slate-300 mb-3">Firm Logo (Optional)</label>

            <label for="brand-logo" class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 btn-secondary rounded-lg">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              <span>Choose Logo File</span>
            </label>

            <input id="brand-logo" type="file" accept="image/*" />
            <span id="brand-logo-file-name" class="text-sm text-slate-400 ml-3">No file selected</span>

            <p class="text-xs text-slate-500 mt-3">Recommended: 600×600 PNG, SVG, or JPG</p>
          </div>

          <div class="drop-zone fade-in" id="pdf-drop-zone">
            <svg class="w-16 h-16 text-purple-400 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
            <p class="text-white font-semibold mb-2">Drop IRS transcript PDF here</p>
            <p class="text-slate-400 text-sm">or click to browse</p>
            <p class="text-slate-500 text-xs mt-3">Supports Form 4506-C (Account, Return, Wage &amp; Income transcripts)</p>
          </div>
          <input id="pdf-upload" type="file" accept="application/pdf" class="hidden" />
        </div>

        <div class="grid gap-4">
          <div class="flex flex-col md:flex-row gap-4">
            <button id="extract-raw-btn" type="button" class="btn-secondary flex-1 opacity-50 cursor-not-allowed" disabled>
              <span>Extract Raw Text</span>
            </button>
            <button id="parse-structured-btn" type="button" class="btn-primary flex-1 opacity-50 cursor-not-allowed" disabled>
              <span>Parse Structured JSON</span>
            </button>
            <a id="preview-report-btn" href="#" class="btn-secondary flex-1 text-center opacity-50 cursor-not-allowed pointer-events-none" aria-disabled="true">Preview Report &amp; Use Token</a>
          </div>

          <div class="mt-4 rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 px-4 py-3 border-b border-slate-700/40">
              <div class="text-sm font-semibold text-white">Email report link (no storage)</div>
              <div class="text-xs text-slate-400">We email a link. The report data lives in the link fragment (not uploaded).</div>
            </div>
            <div class="p-4 grid gap-3 md:grid-cols-[1fr_auto] md:items-end">
              <div>
                <label for="report-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                <input id="report-email" type="email" placeholder="client@firm.com" class="input-field w-full rounded-lg px-4 py-3" autocomplete="email" />
                <p class="text-xs text-slate-400 mt-2">Requires a verified Token ID and parsed JSON. No cookies.</p>
              </div>
              <div class="grid gap-2">
                <button id="report-email-btn" type="button" class="btn-primary px-5 py-3 opacity-50 cursor-not-allowed" disabled>Email report link</button>
                <div id="report-email-status" class="text-xs text-slate-400">Not ready.</div>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
              <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/40">
                <div class="text-sm font-semibold text-white">Raw Text Output</div>
                <button id="copy-raw" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200">Copy</button>
              </div>
              <pre id="raw-output" class="p-4 text-xs text-slate-200 whitespace-pre-wrap break-words max-h-[320px] overflow-auto">(no text yet)</pre>
            </div>

            <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
              <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/40">
                <div class="text-sm font-semibold text-white">Structured JSON Output</div>
                <button id="copy-json" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200">Copy</button>
              </div>
              <pre id="json-output" class="p-4 text-xs text-slate-200 whitespace-pre-wrap break-words max-h-[320px] overflow-auto">(no json yet)</pre>
            </div>
          </div>
        </div>

        <div class="mt-8 p-4 rounded-lg bg-slate-800/30 border border-slate-700/30 flex items-start gap-3">
          <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <div>
            <p class="text-sm text-green-300 font-medium">Privacy Protected</p>
            <p class="text-xs text-slate-400 mt-1">PDFs are processed in your browser. No files are uploaded or stored on our servers.</p>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6 mb-12">
        <div class="glass rounded-xl p-6 border border-purple-500/20">
          <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-300 mb-3" aria-hidden="true">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <h4 class="text-white font-semibold mb-2">Lightning Fast</h4>
          <p class="text-sm text-slate-400">Parse transcripts in seconds. Handle multiple clients back-to-back.</p>
        </div>

        <div class="glass rounded-xl p-6 border border-purple-500/20">
          <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-300 mb-3" aria-hidden="true">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3V7a3 3 0 10-6 0v1c0 1.657 1.343 3 3 3z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 11h12a2 2 0 012 2v7a2 2 0 01-2 2H6a2 2 0 01-2-2v-7a2 2 0 012-2z" />
            </svg>
          </div>
          <h4 class="text-white font-semibold mb-2">Completely Private</h4>
          <p class="text-sm text-slate-400">All processing happens locally in your browser. Zero server uploads.</p>
        </div>

        <div class="glass rounded-xl p-6 border border-purple-500/20">
          <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-300 mb-3" aria-hidden="true">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 19V5" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 19h16" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17V11" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17V7" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 17v-4" />
            </svg>
          </div>
          <h4 class="text-white font-semibold mb-2">Professional Reports</h4>
          <p class="text-sm text-slate-400">Client-ready summaries with your branding, ready to download.</p>
        </div>
      </div>

      <div id="sample-report-container" class="hidden"></div>
    </main>

    <div id="mini-report-overlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
      <div class="relative w-full max-w-5xl h-[85vh] bg-slate-950 rounded-2xl overflow-hidden border border-purple-500/20">
        <button id="mini-report-close" class="absolute top-4 right-4 z-10 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Close</button>
        <iframe id="mini-report-iframe" src="" class="w-full h-full border-0"></iframe>
      </div>
    </div>
  </div>

  <script>
    // Parse Lab: in-browser PDF extraction + first-pass transcript parsing

    // DOM (alphabetical)
    const brandLogoInput = document.getElementById('brand-logo');
    const brandLogoName = document.getElementById('brand-logo-file-name');
    const copyJsonBtn = document.getElementById('copy-json');
    const copyRawBtn = document.getElementById('copy-raw');
    const extractRawBtn = document.getElementById('extract-raw-btn');
    const jsonOutput = document.getElementById('json-output');
    const miniReportClose = document.getElementById('mini-report-close');
    const miniReportIframe = document.getElementById('mini-report-iframe');
    const miniReportOverlay = document.getElementById('mini-report-overlay');
    const parseStructuredBtn = document.getElementById('parse-structured-btn');
    const parserTokenBtn = document.getElementById('parser-save-token');
    const parserTokenInput = document.getElementById('parser-token-id');
    const parserTokenStatus = document.getElementById('parser-token-status');
    const pdfDropZone = document.getElementById('pdf-drop-zone');
    const pdfUpload = document.getElementById('pdf-upload');
    const previewReportBtn = document.getElementById('preview-report-btn');
    const rawOutput = document.getElementById('raw-output');
    const reportEmailBtn = document.getElementById('report-email-btn');
    const reportEmailInput = document.getElementById('report-email');
    const reportEmailStatus = document.getElementById('report-email-status');

    const NL = String.fromCharCode(10);

    const API_BASE = 'https://api.transcript.taxmonitor.pro';

    function isUuidLike(v) {
      const s = String(v || '').trim().toLowerCase();
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(s);
    }

    function isTokenIdFormat(v) {
      const s = String(v || '').trim();
      return /^[A-Za-z0-9_-]{8,128}$/.test(s);
    }

    async function fetchJson(url, opts) {
      const res = await fetch(url, opts);
      const txt = await res.text().catch(() => '');
      let json = null;
      try { json = txt ? JSON.parse(txt) : null; } catch { json = null; }
      return { json, ok: res.ok, res, text: txt };
    }

    async function fetchTokenBalance(tokenId) {
      const q = new URLSearchParams({ tokenId: String(tokenId || '').trim() });
      const url = API_BASE + '/transcript/tokens?' + q.toString();
      const out = await fetchJson(url, { method: 'GET', mode: 'cors', credentials: 'omit' });
      if (!out.ok) {
        const msg = out.json && out.json.error ? String(out.json.error) : (out.text || out.res.statusText);
        throw new Error('Token lookup failed (' + String(out.res.status) + '): ' + msg);
      }
      const remaining = out.json && typeof out.json.remaining === 'number' ? out.json.remaining : null;
      if (remaining === null) throw new Error('Token lookup returned no remaining balance.');
      return remaining;
    }

    async function consumeToken(tokenId, requestId) {
      const url = API_BASE + '/transcript/consume';
      const body = {
        amount: 1,
        requestId,
        tokenId,
      };

      const out = await fetchJson(url, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (!out.ok) {
        const msg = out.json && out.json.error ? String(out.json.error) : (out.text || out.res.statusText);
        throw new Error('Token consume failed (' + String(out.res.status) + '): ' + msg);
      }

      return out.json || {};
    }

    const state = {
      brandLogoDataUrl: '',
      eventId: '',
      lastReportLink: '',
      pdfFile: null,
      rawText: '',
      reportId: '',
      structured: null,
      tokenAvailable: null,
      tokenConsumed: false,
      tokenId: '',
      tokenValid: false,
    };

    // Surface runtime errors in the UI
    function showFatal(err) {
      const msg = String((err && err.message) ? err.message : err);
      try { setTokenStatus('Runtime error: ' + msg, 'error'); } catch {}
    }

    window.addEventListener('error', (e) => {
      showFatal(e && (e.error || e.message || e));
    });

    window.addEventListener('unhandledrejection', (e) => {
      showFatal(e && (e.reason || e));
    });

    function escapeRegexLiteral(s) {
      return String(s || '').replace(/[\\^$.*+?()[\]{}|]/g, '\\$&');
    }

    function isDigit(ch) {
      return ch >= '0' && ch <= '9';
    }

    function setParserAvailable(val) {
      const el = document.getElementById('parser-token-available');
      if (!el) return;
      el.textContent = (val === null || typeof val === 'undefined') ? '-' : String(val);
    }

    function setText(el, text) {
      if (!el) return;
      el.textContent = String(text ?? '');
    }

    function setTokenStatus(msg, tone) {
      const base = 'text-xs p-3 rounded-lg bg-slate-800/30 border border-slate-700/30 ';
      const color = tone === 'error' ? 'text-red-300' : (tone === 'ok' ? 'text-green-300' : 'text-slate-400');
      parserTokenStatus.className = base + color;
      setText(parserTokenStatus, msg);
    }

    function setButtonEnabled(btn, enabled) {
      if (!btn) return;
      btn.disabled = !enabled;
      btn.classList.toggle('opacity-50', !enabled);
      btn.classList.toggle('cursor-not-allowed', !enabled);
    }

    function setPreviewEnabled(enabled) {
      if (enabled) {
        previewReportBtn.classList.remove('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
        previewReportBtn.setAttribute('aria-disabled', 'false');
      } else {
        previewReportBtn.classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
        previewReportBtn.setAttribute('aria-disabled', 'true');
      }
    }

    function updateControls() {
      const hasPdf = !!state.pdfFile;
      const canExtract = state.tokenValid && hasPdf;
      const canParse = state.tokenValid && hasPdf && !!state.rawText;
      const canPreviewUse = state.tokenValid && !!state.structured && !state.tokenConsumed;
      const canEmail = state.tokenValid && !!state.structured && state.tokenConsumed;

      setButtonEnabled(extractRawBtn, canExtract);
      setButtonEnabled(parseStructuredBtn, canParse);
      setButtonEnabled(reportEmailBtn, canEmail);
      setPreviewEnabled(canPreviewUse);

      if (reportEmailStatus && !canEmail) {
        if (!state.tokenValid) setText(reportEmailStatus, 'Verify Token ID to enable emailing.');
        else if (!state.structured) setText(reportEmailStatus, 'Parse JSON to enable emailing.');
        else if (!state.tokenConsumed) setText(reportEmailStatus, 'Click “Preview Report & Use Token” to enable emailing.');
        else setText(reportEmailStatus, 'Not ready.');
      }
    }

    async function copyToClipboard(text) {
      const value = String(text ?? '');
      if (!value) return;
      try {
        await navigator.clipboard.writeText(value);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
    }

    async function ensurePdfJs() {
      if (typeof window.pdfjsLib !== 'undefined') {
        if (!window.pdfjsLib.GlobalWorkerOptions || !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = '/scripts/pdf.worker.min.mjs';
        }
        return;
      }

      const isModule = (src) => String(src || '').toLowerCase().endsWith('.mjs');

      const loadClassicScript = (src) => new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error('Failed to load script: ' + src));
        document.head.appendChild(s);
      });

      const loadModule = async (src) => {
        const mod = await import(src);
        window.pdfjsLib = mod && (mod.default || mod);
      };

      const candidates = [
        '/scripts/pdf.min.mjs',
        '/assets/pdf.min.mjs',
        'https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.min.mjs',
      ];

      let lastErr = null;
      let loadedFrom = '';

      for (const src of candidates) {
        try {
          if (isModule(src)) await loadModule(src);
          else await loadClassicScript(src);

          if (typeof window.pdfjsLib !== 'undefined') {
            loadedFrom = src;
            break;
          }
        } catch (e) {
          lastErr = e;
        }
      }

      if (typeof window.pdfjsLib === 'undefined') {
        const msg = lastErr && lastErr.message ? lastErr.message : 'PDF.js failed to load.';
        throw new Error(
          'PDF.js failed to load (pdfjsLib is undefined). ' + msg +
          ' | Fix: add /scripts/pdf.min.mjs and /scripts/pdf.worker.min.mjs (or /assets equivalents) to your site build output.'
        );
      }

      const workerCandidates = [
        '/scripts/pdf.worker.min.mjs',
        '/assets/pdf.worker.min.mjs',
        'https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs',
      ];

      const preferLocal = loadedFrom.startsWith('/');
      const orderedWorkers = preferLocal
        ? workerCandidates
        : workerCandidates.slice(2).concat(workerCandidates.slice(0, 2));

      window.pdfjsLib.GlobalWorkerOptions.workerSrc = orderedWorkers[0];
    }

    function fromB64Url(s) {
      const str = String(s || '').replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4 ? '='.repeat(4 - (str.length % 4)) : '';
      const bin = atob(str + pad);
      const out = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
      return out;
    }

    function toB64Url(bytes) {
      const u8 = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes || []);
      let bin = '';
      for (let i = 0; i < u8.length; i++) bin += String.fromCharCode(u8[i]);
      return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
    }

    function setReportEmailStatus(msg, tone) {
      if (!reportEmailStatus) return;
      const base = 'text-xs ';
      const color = tone === 'error' ? 'text-red-300' : (tone === 'ok' ? 'text-green-300' : 'text-slate-400');
      reportEmailStatus.className = base + color;
      setText(reportEmailStatus, msg);
    }

    function buildReportModel(structured) {
      const s = structured || {};
      return {
        codesFound: Array.isArray(s.codesFound) ? s.codesFound : [],
        header: s.header || {},
        meta: s.meta || {},
        transactions: Array.isArray(s.transactions) ? s.transactions : [],
        version: s.version || 'unknown',
      };
    }

    async function buildEncryptedReportLink(structured) {
      const model = buildReportModel(structured);
      const plaintext = new TextEncoder().encode(JSON.stringify(model));

      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);
      const rawKey = new Uint8Array(await crypto.subtle.exportKey('raw', key));

      const ciphertext = new Uint8Array(await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, plaintext));

      const k = toB64Url(rawKey);
      const r = toB64Url(ciphertext);
      const v = toB64Url(iv);

      const base = window.location.origin + '/assets/report-preview.html';
      const frag = '#v=1&k=' + encodeURIComponent(k) + '&iv=' + encodeURIComponent(v) + '&r=' + encodeURIComponent(r);
      return base + frag;
    }

    function sanitizeEmail(v) {
      return String(v || '').trim().toLowerCase();
    }

    function escapeHtml(v) {
      const s = String(v ?? '');
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function emailReportLink() {
      if (!state.tokenValid || !state.tokenId) {
        setReportEmailStatus('Verify Token ID first.', 'error');
        return;
      }
      if (!state.structured) {
        setReportEmailStatus('Parse structured JSON first.', 'error');
        return;
      }

      const email = sanitizeEmail(reportEmailInput && reportEmailInput.value);
      if (!email || !email.includes('@')) {
        setReportEmailStatus('Enter a valid email.', 'error');
        return;
      }

      setButtonEnabled(reportEmailBtn, false);
      setReportEmailStatus('Building secure link...', '');

      try {
        const reportUrl = await buildEncryptedReportLink(state.structured);
        state.lastReportLink = reportUrl;

        if (!state.eventId) state.eventId = crypto.randomUUID();
        if (!state.reportId) state.reportId = crypto.randomUUID();

        const body = {
          email,
          eventId: state.eventId,
          reportId: state.reportId,
          reportUrl,
          tokenId: state.tokenId,
        };

        setReportEmailStatus('Sending email...', '');

        const res = await fetch(API_BASE + '/forms/transcript/report-email', {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const t = await res.text().catch(() => '');
          throw new Error('Email endpoint failed (' + String(res.status) + '): ' + (t || res.statusText));
        }

        setReportEmailStatus('✓ Email sent. The link is in their inbox, not on our servers.', 'ok');
      } catch (e) {
        setReportEmailStatus(String(e && e.message ? e.message : e), 'error');
      } finally {
        updateControls();
      }
    }

    async function extractTextFromPDF(file) {
      await ensurePdfJs();
      if (!file) throw new Error('No PDF selected.');

      const buf = await file.arrayBuffer();
      const objectUrl = URL.createObjectURL(file);

      const attempts = [
        { url: objectUrl, stopAtErrors: false },
        { url: objectUrl, stopAtErrors: false, disableWorker: true },
        { data: buf, stopAtErrors: false },
        { data: buf, stopAtErrors: false, disableWorker: true },
      ];

      let lastErr = null;

      try {
        for (const opts of attempts) {
          try {
            const loadingTask = window.pdfjsLib.getDocument(opts);
            const pdf = await loadingTask.promise;

            let out = '';
            for (let p = 1; p <= pdf.numPages; p++) {
              const page = await pdf.getPage(p);
              const content = await page.getTextContent({ disableCombineTextItems: false });
              const parts = [];

              for (const it of content.items || []) {
                if (it && typeof it.str === 'string' && it.str.trim()) parts.push(it.str);
              }

              out += parts.join(' ') + NL;
            }

            const text = out.trim();
            if (!text) throw new Error('No selectable text found. This PDF may be a scanned image (OCR not supported in this tool).');
            return text;
          } catch (e) {
            lastErr = e;
          }
        }
      } finally {
        URL.revokeObjectURL(objectUrl);
      }

      const name = lastErr && lastErr.name ? String(lastErr.name) : 'Error';
      const msg = lastErr && lastErr.message ? String(lastErr.message) : String(lastErr || 'PDF extraction failed.');
      throw new Error(name + ': ' + msg);
    }

    function detectTranscriptType(rawText) {
      const t = String(rawText || '').toLowerCase();
      if (t.includes('record of account')) return 'record_of_account';
      if (t.includes('account transcript')) return 'account';
      if (t.includes('return transcript')) return 'return';
      if (t.includes('wage') && t.includes('income')) return 'wage_income';
      return 'unknown';
    }

    function stripLeadingPunct(s) {
      let out = String(s || '').trim();
      while (out.length && (out[0] === ':' || out[0] === ' ')) out = out.slice(1);
      return out.trim();
    }

    function firstRegexGroup(text, re) {
      const m = String(text || '').match(re);
      return (m && m[1]) ? String(m[1]).trim() : '';
    }

    function normalizeTextForParsing(rawText) {
      const t = String(rawText || '').replace(/\s+/g, ' ').trim();

      const labelStarts = [
        'Account balance:',
        'Accrued interest:',
        'Accrued penalty:',
        'As of:',
        'Filing status:',
        'Form Number:',
        'Processing date:',
        'Report for Tax Period Ending:',
        'Request Date:',
        'Response Date:',
        'Return due date or return received date',
        'Taxpayer Identification Number:',
        'Tracking Number:',
      ];

      let out = t;
      for (const lbl of labelStarts) {
        const safe = escapeRegexLiteral(lbl);
        out = out.replace(new RegExp('\\s(' + safe + ')', 'g'), NL + '$1');
      }

      out = out.replace(/(TRANSACTIONS\s+CODE\s+EXPLANATION\s+OF\s+TRANSACTION\s+CYCLE\s+DATE\s+AMOUNT)\s+/i, '$1' + NL);

      const marker = out.match(/TRANSACTIONS\s+CODE\s+EXPLANATION\s+OF\s+TRANSACTION\s+CYCLE\s+DATE\s+AMOUNT/i);
      if (marker) {
        const idx = out.toLowerCase().indexOf(marker[0].toLowerCase());
        const head = out.slice(0, idx);
        let tail = out.slice(idx);
        tail = tail.replace(/\s(\d{3})\s+([A-Za-z])/g, NL + '$1 $2');
        out = head + tail;
      }

      return out;
    }

    function looksLikeDate10(s) {
      if (!s || s.length !== 10) return false;
      const sep = s[2];
      if (!(sep === '/' || sep === '-')) return false;
      if (s[5] !== sep) return false;

      return isDigit(s[0]) && isDigit(s[1]) &&
        isDigit(s[3]) && isDigit(s[4]) &&
        isDigit(s[6]) && isDigit(s[7]) && isDigit(s[8]) && isDigit(s[9]);
    }

    function extractFirstDate(rawLine) {
      const line = String(rawLine || '');
      for (let i = 0; i < line.length - 9; i++) {
        const candidate = line.slice(i, i + 10);
        if (looksLikeDate10(candidate)) return candidate;
      }
      return '';
    }

    function parseTransactions(rawText) {
      const normalized = normalizeTextForParsing(rawText);
      const lines = String(normalized || '').split(NL).map((l) => String(l).trim()).filter(Boolean);

      const out = [];
      const seen = new Set();

      let startIdx = 0;
      for (let i = 0; i < lines.length; i++) {
        if (String(lines[i]).toLowerCase().includes('transactions code explanation')) {
          startIdx = i + 1;
          break;
        }
      }

      // NOTE: This regex MUST NOT double-escape ($ and \d). It is a regex literal.
      // The previous build accidentally ended up with "\\$" which made "$" an anchor and "?" invalid.
      const amountRe = /(-?\$?\d{1,3}(?:,\d{3})*(?:\.\d{2})|-?\$?\d+(?:\.\d{2}))/g;

      for (let i = startIdx; i < lines.length; i++) {
        const line = lines[i];
        if (seen.has(line)) continue;
        seen.add(line);

        if (line.length < 4) continue;
        const code = line.slice(0, 3);
        if (!isDigit(code[0]) || !isDigit(code[1]) || !isDigit(code[2])) continue;
        if (line[3] !== ' ') continue;

        const rest = line.slice(4).trim();

        const date = extractFirstDate(rest);

        let amount = '';
        const amts = rest.match(amountRe);
        if (amts && amts.length) amount = amts[amts.length - 1];

        let cycle = '';
        const cycle8 = rest.match(/\b(\d{8})\b/);
        if (cycle8 && cycle8[1]) cycle = cycle8[1];

        let description = rest;
        if (amount) description = description.replace(new RegExp('\\s+' + escapeRegexLiteral(amount) + '$'), '');
        if (date) description = description.replace(new RegExp('\\s+' + escapeRegexLiteral(date) + '(\\s+|$)'), ' ').trim();
        if (cycle) description = description.replace(new RegExp('\\s+' + escapeRegexLiteral(cycle) + '(\\s+|$)'), ' ').trim();

        out.push({ amount, code, cycle, date, description: description.trim(), line });
      }

      return out;
    }

    function buildStructured(rawText) {
      const normalized = normalizeTextForParsing(rawText);
      const transcriptType = detectTranscriptType(normalized);

      const requestDate = firstRegexGroup(normalized, /\bRequest Date:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);
      const responseDate = firstRegexGroup(normalized, /\bResponse Date:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);
      const trackingNumber = firstRegexGroup(normalized, /\bTracking Number:\s*([0-9]{6,})/i);
      const formNumber = firstRegexGroup(normalized, /\bForm Number:\s*([0-9A-Za-z-]+)/i);

      const taxPeriodEnding = firstRegexGroup(normalized, /\bReport for Tax Period Ending:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i) ||
        firstRegexGroup(normalized, /\bTax Period Ending:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);

      const tinMasked = firstRegexGroup(normalized, /\bTaxpayer Identification Number:\s*([X\*0-9]{3}-[X\*0-9]{2}-[0-9]{4})/i) ||
        firstRegexGroup(normalized, /\b(?:SSN|TIN):\s*([X\*0-9]{3}-[X\*0-9]{2}-[0-9]{4})/i);

      const accountBalance = firstRegexGroup(normalized, /\bAccount balance:\s*(-?\$?\d{1,3}(?:,\d{3})*(?:\.\d{2})|-?\$?\d+(?:\.\d{2}))/i);

      const transactions = parseTransactions(normalized);

      const codesSet = new Set();
      for (const t of transactions) codesSet.add(t.code);
      const codesFound = Array.from(codesSet).sort();

      return {
        codesFound,
        header: {
          formNumber,
          requestDate,
          responseDate,
          trackingNumber,
        },
        meta: {
          accountBalance,
          taxPeriodEnding,
          tinMasked,
          transcriptType,
        },
        transactions,
        version: 'parse_lab_v4_regex_fixed',
      };
    }

    function handlePdfSelected(file) {
      state.pdfFile = file;
      state.rawText = '';
      state.structured = null;

      setText(rawOutput, '(ready. click Extract Raw Text)');
      setText(jsonOutput, '(no json yet)');

      const p = pdfDropZone.querySelector('p.text-white');
      if (p) {
        const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
        p.textContent = 'Selected: ' + file.name + ' • ' + sizeMb + ' MB';
      }

      updateControls();
    }

    function closeOverlay() {
      miniReportOverlay.classList.add('hidden');
      miniReportIframe.srcdoc = (() => {
        const safe = escapeHtml;

        const safeMeta = {
          accountBalance: safe(meta.accountBalance || '-'),
          taxPeriodEnding: safe(meta.taxPeriodEnding || '-'),
          tinMasked: safe(meta.tinMasked || '-'),
          transcriptType: safe(meta.transcriptType || 'unknown'),
        };

        const rowCount = (state.structured.transactions || []).length;
        const uniqueCodes = (state.structured.codesFound || []).length;

        const transactions = (state.structured.transactions || []).slice(0, 18);
        const txRows = transactions.map((t) => {
          const code = safe(t && t.code ? t.code : '');
          const desc = safe(t && t.description ? t.description : '');
          const date = safe(t && t.date ? t.date : '');
          const amt = safe(t && t.amount ? t.amount : '');
          return (
            '<tr>' +
            '<td class="td mono">' + code + '</td>' +
            '<td class="td">' + desc + '</td>' +
            '<td class="td mono">' + date + '</td>' +
            '<td class="td mono right">' + amt + '</td>' +
            '</tr>'
          );
        }).join('');

        const codesAll = (state.structured.codesFound || []).slice(0, 80);
        const codesHtmlFull = codesAll.map((c) => '<span class="code">' + safe(c) + '</span>').join('');

        const logoBlock = state.brandLogoDataUrl
          ? '<img src="' + state.brandLogoDataUrl + '" alt="Firm logo" style="max-width:160px;height:auto;" />'
          : '<div style="font-weight:800;letter-spacing:-.5px;">Your Firm</div>';

        const subtitle = 'Type: ' + safeMeta.transcriptType + ' • Period ending: ' + safeMeta.taxPeriodEnding;

        return (
          '<!doctype html><html><head><meta charset="utf-8" />' +
          '<meta name="viewport" content="width=device-width, initial-scale=1" />' +
          '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">' +
          '<style>' +
          ':root{--ink:#0b0a14;--muted:#6b7280;--line:#e5e7eb;--p:#7c3aed;--bg:#f3f4f6}' +
          'body{margin:0;background:var(--bg);font-family:DM Sans,system-ui,sans-serif;color:var(--ink)}' +
          '.page{max-width:8.5in;margin:24px auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.12)}' +
          '.content{padding:52px}' +
          '.header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:26px;padding-bottom:18px;border-bottom:2px solid var(--ink)}' +
          '.h1{font-size:30px;font-weight:800;letter-spacing:-.5px;line-height:1.1;margin:0}' +
          '.kicker{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:800;margin-top:8px}' +
          '.sub{font-size:13px;color:var(--muted);margin-top:10px}' +
          '.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:18px 0 26px}' +
          '.stat{border:1px solid var(--line);border-radius:14px;padding:14px;background:linear-gradient(135deg,#fafafa 0%,#f3f4f6 100%)}' +
          '.statN{font-size:20px;font-weight:900;min-height:26px}' +
          '.statL{font-size:11px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-top:6px}' +
          '.section{margin:0 0 26px}' +
          '.title{font-size:13px;font-weight:900;text-transform:uppercase;letter-spacing:.6px;margin:0 0 12px;padding-left:10px;border-left:4px solid var(--p)}' +
          '.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}' +
          '.block{background:#f9fafb;padding:14px;border-radius:12px;border-left:3px solid var(--p)}' +
          '.label{font-size:11px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}' +
          '.value{font-size:15px;font-weight:800}' +
          '.codes{display:flex;flex-wrap:wrap;gap:8px}' +
          '.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:12px;background:#111827;color:#a78bfa;padding:6px 8px;border-radius:999px}' +
          '.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden}' +
          '.th{background:#111827;color:#e5e7eb;font-size:11px;letter-spacing:.6px;text-transform:uppercase;font-weight:900;padding:10px 12px;text-align:left}' +
          '.td{border-top:1px solid var(--line);padding:10px 12px;font-size:12px;vertical-align:top}' +
          '.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}' +
          '.right{text-align:right}' +
          '.note{background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.18);border-left:4px solid var(--p);padding:14px;border-radius:12px;color:#374151;font-size:13px;line-height:1.7}' +
          '.footer{margin-top:28px;padding-top:14px;border-top:1px solid var(--line);display:flex;justify-content:space-between;gap:16px;font-size:11px;color:#9ca3af}' +
          '@media(max-width:640px){.content{padding:28px}.grid{grid-template-columns:1fr}.stats{grid-template-columns:1fr}}' +
          '@media print{body{background:#fff}.page{box-shadow:none;margin:0;border-radius:0}}' +
          '</style></head><body>' +
          '<div class="page"><div class="content">' +
          '<div class="header">' +
          '<div>' +
          '<h1 class="h1">Transcript Report</h1>' +
          '<div class="kicker">Generated locally (no uploads)</div>' +
          '<div class="sub">' + safe(subtitle) + '</div>' +
          '</div>' +
          '<div>' + logoBlock + '</div>' +
          '</div>' +

          '<div class="stats">' +
          '<div class="stat"><div class="statN">' + safeMeta.accountBalance + '</div><div class="statL">Account balance</div></div>' +
          '<div class="stat"><div class="statN">' + String(rowCount) + '</div><div class="statL">Rows detected</div></div>' +
          '<div class="stat"><div class="statN">' + String(uniqueCodes) + '</div><div class="statL">Unique codes</div></div>' +
          '</div>' +

          '<div class="section">' +
          '<div class="title">Taxpayer details</div>' +
          '<div class="grid">' +
          '<div class="block"><div class="label">TIN (masked)</div><div class="value">' + safeMeta.tinMasked + '</div></div>' +
          '<div class="block"><div class="label">Tax period ending</div><div class="value">' + safeMeta.taxPeriodEnding + '</div></div>' +
          '</div>' +
          '</div>' +

          '<div class="section">' +
          '<div class="title">Codes found</div>' +
          '<div class="codes">' + (codesHtmlFull || '<span style="color:var(--muted);font-size:13px;">(none detected)</span>') + '</div>' +
          '</div>' +

          '<div class="section">' +
          '<div class="title">Transactions (first ' + String(transactions.length) + ')</div>' +
          '<table class="table">' +
          '<thead><tr>' +
          '<th class="th">Code</th>' +
          '<th class="th">Description</th>' +
          '<th class="th">Date</th>' +
          '<th class="th right">Amount</th>' +
          '</tr></thead>' +
          '<tbody>' + (txRows || '<tr><td class="td" colspan="4" style="color:var(--muted);">(no rows parsed)</td></tr>') + '</tbody>' +
          '</table>' +
          '</div>' +

          '<div class="note">Tip: This report is generated in your browser. The email link contains encrypted report data in the URL fragment, and nothing is uploaded.</div>' +

          '<div class="footer"><div>Transcript.Tax Monitor Pro</div><div>Generated ' + safe(new Date().toLocaleString()) + '</div></div>' +
          '</div></div></body></html>'
        );
      })();
    });

    miniReportClose.addEventListener('click', () => closeOverlay());
    miniReportOverlay.addEventListener('click', (e) => { if (e.target === miniReportOverlay) closeOverlay(); });

    if (reportEmailBtn) {
      reportEmailBtn.addEventListener('click', (e) => {
        e.preventDefault();
        emailReportLink();
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !miniReportOverlay.classList.contains('hidden')) closeOverlay();
    });

    // Init
    try {
      updateControls();
      setTokenStatus('Ready. Enter a token and click Verify Token.', '');
      runSelfTests();
    } catch (e) {
      showFatal(e);
    }
  </script>
</body>
</html>
