<!-- partials/parse-lab.html -->
<style>
  /* Scoped styles so this partial doesn't hijack the whole site */
  #how-it-works .parse-lab,
  #how-it-works .parse-lab * { box-sizing: border-box; }

  #how-it-works .parse-lab .input-field {
    background: rgba(148, 163, 184, 0.1);
    border: 1px solid rgba(148, 163, 184, 0.3);
    color: white;
    transition: all 0.2s ease;
  }

  #how-it-works .parse-lab .input-field:focus {
    outline: none;
    background: rgba(148, 163, 184, 0.15);
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.12);
  }

  #how-it-works .parse-lab .input-field::placeholder { color: rgba(255,255,255,0.55); }

  #how-it-works .parse-lab button:disabled,
  #how-it-works .parse-lab a[aria-disabled="true"] {
    opacity: 0.55 !important;
    cursor: not-allowed !important;
  }

  #how-it-works .parse-lab .step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 999px;
    font-weight: 800;
    font-size: 14px;
    color: rgb(216 180 254);
    background: rgba(168, 85, 247, 0.18);
    border: 2px solid rgba(168, 85, 247, 0.35);
    flex-shrink: 0;
  }

  #how-it-works .parse-lab .drop-zone {
    border: 2px dashed rgba(168, 85, 247, 0.55);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: rgba(168, 85, 247, 0.06);
  }

  #how-it-works .parse-lab .drop-zone:hover {
    border-color: rgba(168, 85, 247, 0.8);
    background: rgba(168, 85, 247, 0.09);
  }

  #how-it-works .parse-lab .drop-zone.active {
    border-color: rgba(168, 85, 247, 1);
    background: rgba(168, 85, 247, 0.14);
  }
</style>

<div class="parse-lab">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center max-w-3xl mx-auto mb-16">
      <h2 class="font-display text-3xl md:text-4xl font-bold text-white mb-6">Try the Transcript Parser</h2>
      <p class="text-xl text-white/80">Upload a transcript PDF. It parses in your browser. No uploads. No risk.</p>
      <p class="text-sm text-white/60 mt-3">Optional: add your firm logo so the preview report looks like <em>your</em> deliverable.</p>
    </div>

    <div class="grid lg:grid-cols-2 gap-8 items-stretch">
      <!-- Left: Token + Upload -->
      <div class="bg-slate-800/50 backdrop-blur border border-purple-500/30 rounded-2xl p-8 h-full flex flex-col">
        <div class="mb-6">
          <h3 class="text-white font-bold text-lg flex items-center justify-between">
            <span>Enter Your Token</span>
            <span class="step-number">1</span>
          </h3>
        </div>

        <div class="space-y-6 flex-1 flex flex-col">
          <div>
            <label for="parser-token-id" class="block text-white/80 text-xs font-semibold tracking-wide">Token ID</label>
            <input id="parser-token-id" type="text" placeholder="Paste token ID here" class="input-field mt-3 rounded-xl w-full px-4 py-3" autocomplete="off" />

            <div class="mt-4 flex items-center justify-between gap-4">
              <div class="text-xs text-white/60">
                <span class="font-semibold text-white/70">Available credits:</span>
                <span id="parser-token-available" class="ml-2 font-semibold text-white">-</span>
              </div>
              <button id="parser-save-token" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200 underline underline-offset-4">Save Token</button>
            </div>

            <div id="parser-token-status" class="mt-2 text-xs text-white/50">
              Enter a token and click "Save" to check availability and activate the parsing buttons.
            </div>
          </div>

          <div class="mt-8">
            <h3 class="text-white font-bold text-lg mb-2 flex items-center justify-between">
              <span>Upload Transcript PDF</span>
              <span class="step-number">2</span>
            </h3>
          </div>

          <!-- Firm Logo -->
          <div>
            <label class="block text-white/80 text-sm font-medium mb-2">Firm Logo (Optional)</label>

            <div class="flex items-center gap-3">
              <label for="brand-logo" class="cursor-pointer rounded-lg border border-purple-500/30 bg-transparent px-4 py-2 text-sm font-semibold text-purple-200/80 hover:bg-purple-500/10 transition">
                Choose File
              </label>
              <span id="brand-logo-file-name" class="text-sm text-white/80">No file chosen</span>
            </div>

            <input id="brand-logo" type="file" accept="image/*" class="hidden" />
            <p class="text-xs text-white/50 mt-2 mb-3">For best results upload a 600×600 PNG (SVG/JPG ok).</p>
          </div>

          <!-- PDF Drop Zone -->
          <div id="pdf-drop-zone" class="drop-zone flex-1 flex flex-col justify-center">
            <svg class="w-12 h-12 text-purple-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
            <p class="text-white font-medium mb-1">Drop PDF here or click to browse</p>
            <p class="text-white/80 text-sm">Accepts IRS transcripts (Account, Return, Wage &amp; Income)</p>
          </div>
          <input id="pdf-upload" type="file" accept="application/pdf" class="hidden" />

          <div class="grid gap-3">
            <button id="extract-raw-btn" type="button" class="w-full inline-flex items-center justify-center rounded-lg border border-purple-500/30 bg-transparent px-4 py-3 font-semibold text-purple-200/80 shadow-sm transition hover:bg-purple-500/10 hover:text-purple-100 opacity-60 cursor-not-allowed" aria-disabled="true" disabled>
              Extract Raw Text
            </button>

            <button id="parse-structured-btn" type="button" class="w-full inline-flex items-center justify-center rounded-lg bg-purple-600/80 px-4 py-3 font-semibold text-white shadow-sm transition hover:bg-purple-600 opacity-60 cursor-not-allowed" aria-disabled="true" disabled>
              Parse Structured JSON
            </button>

            <a id="preview-report-btn" href="#" class="w-full inline-flex items-center justify-center rounded-lg border border-purple-500/30 bg-transparent px-4 py-3 font-semibold text-purple-200/80 shadow-sm transition hover:bg-purple-500/10 hover:text-purple-100 opacity-60 cursor-not-allowed pointer-events-none" rel="noopener" aria-disabled="true" tabindex="-1">
              Preview Report &amp; Use Token
            </a>
          </div>

          <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-600">
            <p class="text-white/70 text-xs flex items-center gap-2">
              <svg class="w-4 h-4 text-green-400" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <path d="M22 4 12 14.01l-3-3" />
              </svg>
              Runs in your browser. Your PDF is not uploaded or stored.
            </p>
          </div>
        </div>
      </div>

      <!-- Right: Outputs + preview note -->
      <div class="bg-slate-800/50 backdrop-blur border border-purple-500/20 rounded-2xl p-8 h-full flex flex-col">
        <div class="mb-4">
          <h3 class="text-white font-bold text-lg flex items-center justify-between">
            <span>Outputs</span>
            <span class="step-number">3</span>
          </h3>
        </div>

        <div class="space-y-4 text-sm flex-1">
          <div class="mt-2 bg-purple-600/10 border border-purple-500/30 rounded-lg p-4">
            <p class="text-purple-300 text-sm font-medium mb-2">PREVIEW MODE</p>
            <p class="text-white/70 text-sm">Verify token → upload PDF → extract → parse → preview. Preview consumes 1 credit.</p>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
              <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/40">
                <div class="text-sm font-semibold text-white">Raw Text Output</div>
                <button id="copy-raw" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200">Copy</button>
              </div>
              <pre id="raw-output" class="p-4 text-xs text-slate-200 whitespace-pre-wrap break-words max-h-[360px] overflow-auto">(no text yet)</pre>
            </div>

            <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
              <div class="flex items-center justify-between px-4 py-3 border-b border-slate-700/40">
                <div class="text-sm font-semibold text-white">Structured JSON Output</div>
                <button id="copy-json" type="button" class="text-xs font-semibold text-purple-300 hover:text-purple-200">Copy</button>
              </div>
              <pre id="json-output" class="p-4 text-xs text-slate-200 whitespace-pre-wrap break-words max-h-[360px] overflow-auto">(no json yet)</pre>
            </div>
          </div>

          <div class="rounded-xl border border-slate-700/40 bg-slate-950/30 overflow-hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 px-4 py-3 border-b border-slate-700/40">
              <div class="text-sm font-semibold text-white">Email report link (no storage)</div>
              <div class="text-xs text-slate-400">Encrypted report data lives in the URL fragment (not uploaded).</div>
            </div>
            <div class="p-4 grid gap-3 md:grid-cols-[1fr_auto] md:items-end">
              <div>
                <label for="report-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                <input id="report-email" type="email" placeholder="client@firm.com" class="input-field w-full rounded-lg px-4 py-3" autocomplete="email" />
                <p class="text-xs text-slate-400 mt-2">Requires token + parsed JSON + 1 consumed credit.</p>
              </div>
              <div class="grid gap-2">
                <button id="report-email-btn" type="button" class="inline-flex items-center justify-center rounded-lg bg-purple-600/80 px-5 py-3 text-sm font-semibold text-white transition hover:bg-purple-600 opacity-60 cursor-not-allowed" disabled>
                  Email report link
                </button>
                <div id="report-email-status" class="text-xs text-slate-400">Not ready.</div>
              </div>
            </div>
          </div>
        </div>

        <div id="sample-report-container" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="mini-report-overlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
    <div class="relative w-full max-w-5xl h-[85vh] bg-slate-950 rounded-2xl overflow-hidden border border-purple-500/20">
      <button id="mini-report-close" class="absolute top-4 right-4 z-10 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Close</button>
      <iframe id="mini-report-iframe" src="about:blank" class="w-full h-full border-0"></iframe>
    </div>
  </div>
</div>

<script>
  // Parse Lab (partial): in-browser PDF extraction + first-pass transcript parsing

  // DOM (alphabetical)
  const brandLogoInput = document.getElementById('brand-logo');
  const brandLogoName = document.getElementById('brand-logo-file-name');
  const copyJsonBtn = document.getElementById('copy-json');
  const copyRawBtn = document.getElementById('copy-raw');
  const extractRawBtn = document.getElementById('extract-raw-btn');
  const jsonOutput = document.getElementById('json-output');
  const miniReportClose = document.getElementById('mini-report-close');
  const miniReportIframe = document.getElementById('mini-report-iframe');
  const miniReportOverlay = document.getElementById('mini-report-overlay');
  const parseStructuredBtn = document.getElementById('parse-structured-btn');
  const parserTokenBtn = document.getElementById('parser-save-token');
  const parserTokenInput = document.getElementById('parser-token-id');
  const parserTokenStatus = document.getElementById('parser-token-status');
  const pdfDropZone = document.getElementById('pdf-drop-zone');
  const pdfUpload = document.getElementById('pdf-upload');
  const previewReportBtn = document.getElementById('preview-report-btn');
  const rawOutput = document.getElementById('raw-output');
  const reportEmailBtn = document.getElementById('report-email-btn');
  const reportEmailInput = document.getElementById('report-email');
  const reportEmailStatus = document.getElementById('report-email-status');

  const API_BASE = 'https://api.transcript.taxmonitor.pro';
  const NL = String.fromCharCode(10);

  const state = {
    brandLogoDataUrl: '',
    eventId: '',
    lastReportLink: '',
    pdfFile: null,
    rawText: '',
    reportId: '',
    structured: null,
    tokenAvailable: null,
    tokenConsumed: false,
    tokenId: '',
    tokenValid: false,
  };

  function setText(el, text) {
    if (!el) return;
    el.textContent = String(text ?? '');
  }

  function setButtonEnabled(btn, enabled) {
    if (!btn) return;
    btn.disabled = !enabled;
    btn.classList.toggle('opacity-60', !enabled);
    btn.classList.toggle('cursor-not-allowed', !enabled);
  }

  function setTokenStatus(msg, tone) {
    if (!parserTokenStatus) return;
    const base = 'mt-2 text-xs ';
    const cls = tone === 'error'
      ? 'text-red-300'
      : (tone === 'ok' ? 'text-green-300' : 'text-white/50');
    parserTokenStatus.className = base + cls;
    setText(parserTokenStatus, msg);
  }

  function setParserAvailable(val) {
    const el = document.getElementById('parser-token-available');
    if (!el) return;
    el.textContent = (val === null || typeof val === 'undefined') ? '-' : String(val);
  }

  function setReportEmailStatus(msg, tone) {
    if (!reportEmailStatus) return;
    const base = 'text-xs ';
    const cls = tone === 'error' ? 'text-red-300' : (tone === 'ok' ? 'text-green-300' : 'text-slate-400');
    reportEmailStatus.className = base + cls;
    setText(reportEmailStatus, msg);
  }

  function setPreviewEnabled(enabled) {
    if (!previewReportBtn) return;
    if (enabled) {
      previewReportBtn.classList.remove('opacity-60', 'pointer-events-none', 'cursor-not-allowed');
      previewReportBtn.setAttribute('aria-disabled', 'false');
      previewReportBtn.tabIndex = 0;
      previewReportBtn.href = '#';
    } else {
      previewReportBtn.classList.add('opacity-60', 'pointer-events-none', 'cursor-not-allowed');
      previewReportBtn.setAttribute('aria-disabled', 'true');
      previewReportBtn.tabIndex = -1;
      previewReportBtn.href = '#';
    }
  }

  function updateControls() {
    const hasPdf = !!state.pdfFile;
    const canExtract = state.tokenValid && hasPdf;
    const canParse = state.tokenValid && hasPdf && !!state.rawText;
    const canPreviewUse = state.tokenValid && !!state.structured && !state.tokenConsumed;
    const canEmail = state.tokenValid && !!state.structured && state.tokenConsumed;

    setButtonEnabled(extractRawBtn, canExtract);
    setButtonEnabled(parseStructuredBtn, canParse);
    setButtonEnabled(reportEmailBtn, canEmail);
    setPreviewEnabled(canPreviewUse);

    if (reportEmailStatus && !canEmail) {
      if (!state.tokenValid) setText(reportEmailStatus, 'Verify Token ID to enable emailing.');
      else if (!state.structured) setText(reportEmailStatus, 'Parse JSON to enable emailing.');
      else if (!state.tokenConsumed) setText(reportEmailStatus, 'Click “Preview Report & Use Token” to enable emailing.');
      else setText(reportEmailStatus, 'Not ready.');
    }
  }

  async function fetchJson(url, opts) {
    const res = await fetch(url, opts);
    const txt = await res.text().catch(() => '');
    let json = null;
    try { json = txt ? JSON.parse(txt) : null; } catch { json = null; }
    return { json, ok: res.ok, res, text: txt };
  }

  async function fetchTokenBalance(tokenId) {
    const q = new URLSearchParams({ tokenId: String(tokenId || '').trim() });
    const url = API_BASE + '/transcript/tokens?' + q.toString();
    const out = await fetchJson(url, { method: 'GET', mode: 'cors', credentials: 'omit' });

    if (!out.ok) {
      const msg = out.json && out.json.error ? String(out.json.error) : (out.text || out.res.statusText);
      throw new Error('Token lookup failed (' + String(out.res.status) + '): ' + msg);
    }

    const remaining = out.json && typeof out.json.remaining === 'number' ? out.json.remaining : null;
    if (remaining === null) throw new Error('Token lookup returned no remaining balance.');
    return remaining;
  }

  async function consumeToken(tokenId, requestId) {
    const url = API_BASE + '/transcript/consume';
    const body = { amount: 1, requestId, tokenId };

    const out = await fetchJson(url, {
      method: 'POST',
      mode: 'cors',
      credentials: 'omit',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!out.ok) {
      const msg = out.json && out.json.error ? String(out.json.error) : (out.text || out.res.statusText);
      throw new Error('Token consume failed (' + String(out.res.status) + '): ' + msg);
    }

    return out.json || {};
  }

  async function copyToClipboard(text) {
    const value = String(text ?? '');
    if (!value) return;

    try {
      await navigator.clipboard.writeText(value);
    } catch {
      const ta = document.createElement('textarea');
      ta.value = value;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  async function ensurePdfJs() {
    // index.html already loads pdf.js; we just need workerSrc sane.
    if (typeof window.pdfjsLib === 'undefined') {
      throw new Error('pdfjsLib is undefined. Ensure pdf.js is loaded on index.html before this partial.');
    }
    if (!window.pdfjsLib.GlobalWorkerOptions || !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js';
    }
  }

  async function extractTextFromPDF(file) {
    await ensurePdfJs();
    if (!file) throw new Error('No PDF selected.');

    const buf = await file.arrayBuffer();
    const loadingTask = window.pdfjsLib.getDocument({ data: buf, stopAtErrors: false });
    const pdf = await loadingTask.promise;

    let out = '';
    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent({ disableCombineTextItems: false });
      const parts = [];

      for (const it of content.items || []) {
        if (it && typeof it.str === 'string' && it.str.trim()) parts.push(it.str);
      }

      out += parts.join(' ') + NL;
    }

    const text = out.trim();
    if (!text) throw new Error('No selectable text found. This PDF may be scanned (OCR not supported).');
    return text;
  }

  function escapeRegexLiteral(s) {
    return String(s || '').replace(/[\\^$.*+?()[\]{}|]/g, '\\$&');
  }

  function isDigit(ch) {
    return ch >= '0' && ch <= '9';
  }

  function looksLikeDate10(s) {
    if (!s || s.length !== 10) return false;
    const sep = s[2];
    if (!(sep === '/' || sep === '-')) return false;
    if (s[5] !== sep) return false;

    return isDigit(s[0]) && isDigit(s[1]) &&
      isDigit(s[3]) && isDigit(s[4]) &&
      isDigit(s[6]) && isDigit(s[7]) && isDigit(s[8]) && isDigit(s[9]);
  }

  function extractFirstDate(rawLine) {
    const line = String(rawLine || '');
    for (let i = 0; i < line.length - 9; i++) {
      const candidate = line.slice(i, i + 10);
      if (looksLikeDate10(candidate)) return candidate;
    }
    return '';
  }

  function firstRegexGroup(text, re) {
    const m = String(text || '').match(re);
    return (m && m[1]) ? String(m[1]).trim() : '';
  }

  function detectTranscriptType(rawText) {
    const t = String(rawText || '').toLowerCase();
    if (t.includes('record of account')) return 'record_of_account';
    if (t.includes('account transcript')) return 'account';
    if (t.includes('return transcript')) return 'return';
    if (t.includes('wage') && t.includes('income')) return 'wage_income';
    return 'unknown';
  }

  function normalizeTextForParsing(rawText) {
    const t = String(rawText || '').replace(/\s+/g, ' ').trim();

    const labelStarts = [
      'Account balance:',
      'Accrued interest:',
      'Accrued penalty:',
      'As of:',
      'Filing status:',
      'Form Number:',
      'Processing date:',
      'Report for Tax Period Ending:',
      'Request Date:',
      'Response Date:',
      'Return due date or return received date',
      'Taxpayer Identification Number:',
      'Tracking Number:',
    ].slice().sort((a, b) => String(a).localeCompare(String(b)));

    let out = t;
    for (const lbl of labelStarts) {
      const safe = escapeRegexLiteral(lbl);
      out = out.replace(new RegExp('\\s(' + safe + ')', 'g'), NL + '$1');
    }

    out = out.replace(/(TRANSACTIONS\s+CODE\s+EXPLANATION\s+OF\s+TRANSACTION\s+CYCLE\s+DATE\s+AMOUNT)\s+/i, '$1' + NL);

    const marker = out.match(/TRANSACTIONS\s+CODE\s+EXPLANATION\s+OF\s+TRANSACTION\s+CYCLE\s+DATE\s+AMOUNT/i);
    if (marker) {
      const idx = out.toLowerCase().indexOf(marker[0].toLowerCase());
      const head = out.slice(0, idx);
      let tail = out.slice(idx);
      tail = tail.replace(/\s(\d{3})\s+([A-Za-z])/g, NL + '$1 $2');
      out = head + tail;
    }

    return out;
  }

  function parseTransactions(rawText) {
    const normalized = normalizeTextForParsing(rawText);
    const lines = String(normalized || '').split(NL).map((l) => String(l).trim()).filter(Boolean);

    const out = [];
    const seen = new Set();

    let startIdx = 0;
    for (let i = 0; i < lines.length; i++) {
      if (String(lines[i]).toLowerCase().includes('transactions code explanation')) {
        startIdx = i + 1;
        break;
      }
    }

    const amountRe = /(-?\$?\d{1,3}(?:,\d{3})*(?:\.\d{2})|-?\$?\d+(?:\.\d{2}))/g;

    for (let i = startIdx; i < lines.length; i++) {
      const line = lines[i];
      if (seen.has(line)) continue;
      seen.add(line);

      if (line.length < 4) continue;
      const code = line.slice(0, 3);
      if (!isDigit(code[0]) || !isDigit(code[1]) || !isDigit(code[2])) continue;
      if (line[3] !== ' ') continue;

      const rest = line.slice(4).trim();

      const date = extractFirstDate(rest);

      let amount = '';
      const amts = rest.match(amountRe);
      if (amts && amts.length) amount = amts[amts.length - 1];

      let cycle = '';
      const cycle8 = rest.match(/\b(\d{8})\b/);
      if (cycle8 && cycle8[1]) cycle = cycle8[1];

      let description = rest;
      if (amount) description = description.replace(new RegExp('\\s+' + escapeRegexLiteral(amount) + '$'), '');
      if (date) description = description.replace(new RegExp('\\s+' + escapeRegexLiteral(date) + '(\\s+|$)'), ' ').trim();
      if (cycle) description = description.replace(new RegExp('\\s+' + escapeRegexLiteral(cycle) + '(\\s+|$)'), ' ').trim();

      out.push({ amount, code, cycle, date, description: description.trim(), line });
    }

    return out;
  }

  function buildStructured(rawText) {
    const normalized = normalizeTextForParsing(rawText);
    const transcriptType = detectTranscriptType(normalized);

    const requestDate = firstRegexGroup(normalized, /\bRequest Date:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);
    const responseDate = firstRegexGroup(normalized, /\bResponse Date:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);
    const trackingNumber = firstRegexGroup(normalized, /\bTracking Number:\s*([0-9]{6,})/i);
    const formNumber = firstRegexGroup(normalized, /\bForm Number:\s*([0-9A-Za-z-]+)/i);

    const taxPeriodEnding = firstRegexGroup(normalized, /\bReport for Tax Period Ending:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i) ||
      firstRegexGroup(normalized, /\bTax Period Ending:\s*(\d{2}[-/]\d{2}[-/]\d{4})/i);

    const tinMasked = firstRegexGroup(normalized, /\bTaxpayer Identification Number:\s*([X\*0-9]{3}-[X\*0-9]{2}-[0-9]{4})/i) ||
      firstRegexGroup(normalized, /\b(?:SSN|TIN):\s*([X\*0-9]{3}-[X\*0-9]{2}-[0-9]{4})/i);

    const accountBalance = firstRegexGroup(normalized, /\bAccount balance:\s*(-?\$?\d{1,3}(?:,\d{3})*(?:\.\d{2})|-?\$?\d+(?:\.\d{2}))/i);

    const transactions = parseTransactions(normalized);

    const codesSet = new Set();
    for (const t of transactions) codesSet.add(t.code);
    const codesFound = Array.from(codesSet).sort((a, b) => String(a).localeCompare(String(b)));

    return {
      codesFound,
      header: { formNumber, requestDate, responseDate, trackingNumber },
      meta: { accountBalance, taxPeriodEnding, tinMasked, transcriptType },
      transactions,
      version: 'parse_lab_partial_v1',
    };
  }

  function escapeHtml(v) {
    const s = String(v ?? '');
    return s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function toB64Url(bytes) {
    const u8 = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes || []);
    let bin = '';
    for (let i = 0; i < u8.length; i++) bin += String.fromCharCode(u8[i]);
    return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
  }

  async function buildEncryptedReportLink(structured) {
    const model = {
      codesFound: Array.isArray(structured?.codesFound) ? structured.codesFound : [],
      header: structured?.header || {},
      meta: structured?.meta || {},
      transactions: Array.isArray(structured?.transactions) ? structured.transactions : [],
      version: structured?.version || 'unknown',
    };

    const plaintext = new TextEncoder().encode(JSON.stringify(model));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);
    const rawKey = new Uint8Array(await crypto.subtle.exportKey('raw', key));
    const ciphertext = new Uint8Array(await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, plaintext));

    const k = toB64Url(rawKey);
    const r = toB64Url(ciphertext);
    const v = toB64Url(iv);

    const base = window.location.origin + '/assets/report-preview.html';
    const frag = '#v=1&k=' + encodeURIComponent(k) + '&iv=' + encodeURIComponent(v) + '&r=' + encodeURIComponent(r);
    return base + frag;
  }

  function handlePdfSelected(file) {
    state.pdfFile = file;
    state.rawText = '';
    state.structured = null;

    setText(rawOutput, '(ready. click Extract Raw Text)');
    setText(jsonOutput, '(no json yet)');

    const p = pdfDropZone ? pdfDropZone.querySelector('p.text-white') : null;
    if (p && file) {
      const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
      p.textContent = 'Selected: ' + file.name + ' • ' + sizeMb + ' MB';
    }

    updateControls();
  }

  function openOverlayWithReport() {
    if (!state.structured) return;

    const safe = escapeHtml;
    const meta = state.structured.meta || {};
    const header = state.structured.header || {};

    const safeMeta = {
      accountBalance: safe(meta.accountBalance || '-'),
      taxPeriodEnding: safe(meta.taxPeriodEnding || '-'),
      tinMasked: safe(meta.tinMasked || '-'),
      transcriptType: safe(meta.transcriptType || 'unknown'),
    };

    const rowCount = (state.structured.transactions || []).length;
    const uniqueCodes = (state.structured.codesFound || []).length;

    const transactions = (state.structured.transactions || []).slice(0, 18);
    const txRows = transactions.map((t) => {
      const code = safe(t?.code || '');
      const desc = safe(t?.description || '');
      const date = safe(t?.date || '');
      const amt = safe(t?.amount || '');
      return (
        '<tr>' +
          '<td class="td mono">' + code + '</td>' +
          '<td class="td">' + desc + '</td>' +
          '<td class="td mono">' + date + '</td>' +
          '<td class="td mono right">' + amt + '</td>' +
        '</tr>'
      );
    }).join('');

    const codesAll = (state.structured.codesFound || []).slice(0, 80);
    const codesHtmlFull = codesAll.map((c) => '<span class="code">' + safe(c) + '</span>').join('');

    const subtitle = 'Type: ' + safeMeta.transcriptType + ' • Period ending: ' + safeMeta.taxPeriodEnding;

    const logoBlock = state.brandLogoDataUrl
      ? '<img src="' + state.brandLogoDataUrl + '" alt="Firm logo" style="max-width:160px;height:auto;" />'
      : '<div style="font-weight:800;letter-spacing:-.5px;">Your Firm</div>';

    const srcdoc =
      '<!doctype html><html><head><meta charset="utf-8" />' +
      '<meta name="viewport" content="width=device-width, initial-scale=1" />' +
      '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">' +
      '<style>' +
      ':root{--ink:#0b0a14;--muted:#6b7280;--line:#e5e7eb;--p:#7c3aed;--bg:#f3f4f6}' +
      'body{margin:0;background:var(--bg);font-family:DM Sans,system-ui,sans-serif;color:var(--ink)}' +
      '.page{max-width:8.5in;margin:24px auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.12)}' +
      '.content{padding:52px}' +
      '.header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:26px;padding-bottom:18px;border-bottom:2px solid var(--ink)}' +
      '.h1{font-size:30px;font-weight:800;letter-spacing:-.5px;line-height:1.1;margin:0}' +
      '.kicker{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:800;margin-top:8px}' +
      '.sub{font-size:13px;color:var(--muted);margin-top:10px}' +
      '.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:18px 0 26px}' +
      '.stat{border:1px solid var(--line);border-radius:14px;padding:14px;background:linear-gradient(135deg,#fafafa 0%,#f3f4f6 100%)}' +
      '.statN{font-size:20px;font-weight:900;min-height:26px}' +
      '.statL{font-size:11px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-top:6px}' +
      '.section{margin:0 0 26px}' +
      '.title{font-size:13px;font-weight:900;text-transform:uppercase;letter-spacing:.6px;margin:0 0 12px;padding-left:10px;border-left:4px solid var(--p)}' +
      '.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}' +
      '.block{background:#f9fafb;padding:14px;border-radius:12px;border-left:3px solid var(--p)}' +
      '.label{font-size:11px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}' +
      '.value{font-size:15px;font-weight:800}' +
      '.codes{display:flex;flex-wrap:wrap;gap:8px}' +
      '.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:12px;background:#111827;color:#a78bfa;padding:6px 8px;border-radius:999px}' +
      '.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden}' +
      '.th{background:#111827;color:#e5e7eb;font-size:11px;letter-spacing:.6px;text-transform:uppercase;font-weight:900;padding:10px 12px;text-align:left}' +
      '.td{border-top:1px solid var(--line);padding:10px 12px;font-size:12px;vertical-align:top}' +
      '.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}' +
      '.right{text-align:right}' +
      '.note{background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.18);border-left:4px solid var(--p);padding:14px;border-radius:12px;color:#374151;font-size:13px;line-height:1.7}' +
      '.footer{margin-top:28px;padding-top:14px;border-top:1px solid var(--line);display:flex;justify-content:space-between;gap:16px;font-size:11px;color:#9ca3af}' +
      '@media(max-width:640px){.content{padding:28px}.grid{grid-template-columns:1fr}.stats{grid-template-columns:1fr}}' +
      '@media print{body{background:#fff}.page{box-shadow:none;margin:0;border-radius:0}}' +
      '</style></head><body>' +
      '<div class="page"><div class="content">' +
      '<div class="header">' +
        '<div>' +
          '<h1 class="h1">Transcript Report</h1>' +
          '<div class="kicker">Generated locally (no uploads)</div>' +
          '<div class="sub">' + subtitle + '</div>' +
        '</div>' +
        '<div>' + logoBlock + '</div>' +
      '</div>' +
      '<div class="stats">' +
        '<div class="stat"><div class="statN">' + safeMeta.accountBalance + '</div><div class="statL">Account balance</div></div>' +
        '<div class="stat"><div class="statN">' + String(rowCount) + '</div><div class="statL">Rows detected</div></div>' +
        '<div class="stat"><div class="statN">' + String(uniqueCodes) + '</div><div class="statL">Unique codes</div></div>' +
      '</div>' +
      '<div class="section">' +
        '<div class="title">Taxpayer details</div>' +
        '<div class="grid">' +
          '<div class="block"><div class="label">TIN (masked)</div><div class="value">' + safeMeta.tinMasked + '</div></div>' +
          '<div class="block"><div class="label">Tax period ending</div><div class="value">' + safeMeta.taxPeriodEnding + '</div></div>' +
        '</div>' +
      '</div>' +
      '<div class="section"><div class="title">Codes found</div><div class="codes">' +
        (codesHtmlFull || '<span style="color:var(--muted);font-size:13px;">(none detected)</span>') +
      '</div></div>' +
      '<div class="section">' +
        '<div class="title">Transactions (first ' + String(transactions.length) + ')</div>' +
        '<table class="table"><thead><tr>' +
          '<th class="th">Code</th><th class="th">Description</th><th class="th">Date</th><th class="th right">Amount</th>' +
        '</tr></thead><tbody>' +
          (txRows || '<tr><td class="td" colspan="4" style="color:var(--muted);">(no rows parsed)</td></tr>') +
        '</tbody></table>' +
      '</div>' +
      '<div class="note">Tip: The email link contains encrypted report data in the URL fragment. Nothing is uploaded.</div>' +
      '<div class="footer"><div>Transcript.Tax Monitor Pro</div><div>Generated ' + safe(new Date().toLocaleString()) + '</div></div>' +
      '</div></div></body></html>';

    miniReportIframe.srcdoc = srcdoc;
    miniReportOverlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeOverlay() {
    miniReportOverlay.classList.add('hidden');
    miniReportIframe.srcdoc = '';
    document.body.style.overflow = '';
  }

  async function verifyToken() {
    const tokenId = String(parserTokenInput?.value || '').trim();
    if (!tokenId) {
      state.tokenValid = false;
      state.tokenId = '';
      setParserAvailable('-');
      setTokenStatus('Token ID is empty.', 'error');
      updateControls();
      return;
    }

    setTokenStatus('Checking token...', '');
    try {
      const remaining = await fetchTokenBalance(tokenId);
      state.tokenValid = true;
      state.tokenId = tokenId;
      state.tokenAvailable = remaining;
      setParserAvailable(remaining);
      setTokenStatus('Token saved. ' + String(remaining) + ' credits available.', 'ok');
    } catch (e) {
      state.tokenValid = false;
      state.tokenId = '';
      setParserAvailable('-');
      setTokenStatus(String(e?.message || e), 'error');
    } finally {
      updateControls();
    }
  }

  async function extractRaw() {
    if (!state.tokenValid) return;
    if (!state.pdfFile) return;

    setButtonEnabled(extractRawBtn, false);
    setText(rawOutput, 'Extracting text...');
    try {
      const text = await extractTextFromPDF(state.pdfFile);
      state.rawText = text;
      setText(rawOutput, text);
    } catch (e) {
      setText(rawOutput, String(e?.message || e));
    } finally {
      updateControls();
    }
  }

  async function parseStructured() {
    if (!state.tokenValid) return;
    if (!state.rawText) return;

    setButtonEnabled(parseStructuredBtn, false);
    setText(jsonOutput, 'Parsing...');
    try {
      const structured = buildStructured(state.rawText);
      state.structured = structured;
      setText(jsonOutput, JSON.stringify(structured, null, 2));
    } catch (e) {
      setText(jsonOutput, String(e?.message || e));
    } finally {
      updateControls();
    }
  }

  async function previewAndConsume() {
    if (!state.tokenValid || !state.tokenId) return;
    if (!state.structured) return;
    if (state.tokenConsumed) return;

    setPreviewEnabled(false);
    try {
      if (!state.eventId) state.eventId = crypto.randomUUID();
      await consumeToken(state.tokenId, state.eventId);
      state.tokenConsumed = true;

      openOverlayWithReport();
      updateControls();
    } catch (e) {
      state.tokenConsumed = false;
      setTokenStatus(String(e?.message || e), 'error');
      updateControls();
    }
  }

  async function emailReportLink() {
    if (!state.tokenValid || !state.tokenId) {
      setReportEmailStatus('Verify Token ID first.', 'error');
      return;
    }
    if (!state.structured) {
      setReportEmailStatus('Parse structured JSON first.', 'error');
      return;
    }
    if (!state.tokenConsumed) {
      setReportEmailStatus('Preview report (consumes 1 credit) before emailing.', 'error');
      return;
    }

    const email = String(reportEmailInput?.value || '').trim().toLowerCase();
    if (!email || !email.includes('@')) {
      setReportEmailStatus('Enter a valid email.', 'error');
      return;
    }

    setButtonEnabled(reportEmailBtn, false);
    setReportEmailStatus('Building secure link...', '');

    try {
      const reportUrl = await buildEncryptedReportLink(state.structured);
      state.lastReportLink = reportUrl;

      if (!state.eventId) state.eventId = crypto.randomUUID();
      if (!state.reportId) state.reportId = crypto.randomUUID();

      setReportEmailStatus('Sending email...', '');

      const res = await fetch(API_BASE + '/forms/transcript/report-email', {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          eventId: state.eventId,
          reportId: state.reportId,
          reportUrl,
          tokenId: state.tokenId,
        }),
      });

      if (!res.ok) {
        const t = await res.text().catch(() => '');
        throw new Error('Email endpoint failed (' + String(res.status) + '): ' + (t || res.statusText));
      }

      setReportEmailStatus('✓ Email sent. Link is in their inbox, not stored on our servers.', 'ok');
    } catch (e) {
      setReportEmailStatus(String(e?.message || e), 'error');
    } finally {
      updateControls();
    }
  }

  // Events
  if (brandLogoInput && brandLogoName) {
    brandLogoInput.addEventListener('change', () => {
      const file = brandLogoInput.files && brandLogoInput.files[0];
      brandLogoName.textContent = file ? String(file.name || '') : 'No file chosen';

      if (!file) {
        state.brandLogoDataUrl = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => { state.brandLogoDataUrl = String(reader.result || ''); };
      reader.readAsDataURL(file);
    });
  }

  if (pdfDropZone && pdfUpload) {
    pdfDropZone.addEventListener('click', () => pdfUpload.click());

    pdfDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      pdfDropZone.classList.add('active');
    });

    pdfDropZone.addEventListener('dragleave', () => {
      pdfDropZone.classList.remove('active');
    });

    pdfDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      pdfDropZone.classList.remove('active');
      const f = e.dataTransfer?.files?.[0];
      if (f) handlePdfSelected(f);
    });

    pdfUpload.addEventListener('change', () => {
      const f = pdfUpload.files && pdfUpload.files[0];
      if (f) handlePdfSelected(f);
    });
  }

  if (parserTokenBtn) parserTokenBtn.addEventListener('click', (e) => { e.preventDefault(); verifyToken(); });
  if (extractRawBtn) extractRawBtn.addEventListener('click', (e) => { e.preventDefault(); extractRaw(); });
  if (parseStructuredBtn) parseStructuredBtn.addEventListener('click', (e) => { e.preventDefault(); parseStructured(); });

  if (previewReportBtn) previewReportBtn.addEventListener('click', (e) => { e.preventDefault(); previewAndConsume(); });

  if (reportEmailBtn) reportEmailBtn.addEventListener('click', (e) => { e.preventDefault(); emailReportLink(); });

  if (copyRawBtn) copyRawBtn.addEventListener('click', (e) => { e.preventDefault(); copyToClipboard(rawOutput?.textContent || ''); });
  if (copyJsonBtn) copyJsonBtn.addEventListener('click', (e) => { e.preventDefault(); copyToClipboard(jsonOutput?.textContent || ''); });

  if (miniReportClose) miniReportClose.addEventListener('click', () => closeOverlay());
  if (miniReportOverlay) {
    miniReportOverlay.addEventListener('click', (e) => {
      if (e.target === miniReportOverlay) closeOverlay();
    });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && miniReportOverlay && !miniReportOverlay.classList.contains('hidden')) closeOverlay();
  });

  // Init
  try {
    updateControls();
    setTokenStatus('Ready. Enter a token and click Save Token.', '');
  } catch (e) {
    setTokenStatus(String(e?.message || e), 'error');
  }
</script>
